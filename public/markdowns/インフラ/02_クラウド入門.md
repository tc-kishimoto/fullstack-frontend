# クラウド入門

---

## クラウドとオンプレミス

一昔前までシステムを構築すると言えば、ハードウェアを調達し、OSをインストールし、各種ソフトウェアのセットアップを行うことから始めました。
昨今ではクラウドの波が押し寄せ、短納期、低コスト化が実現されています。
ここでは自ら設備を揃えるオンプレミスと、IaaSやPaaSなどに代表されるクラウドサービスを簡単に比較しておきたいと思います（詳細は後述）。

---

### オンプレミス

* メリット
  * 要望に合わせた機器や構成のカスタマイズが容易
  * 自社内の閉じたネットワークで構築、運用できる安心感
  * 社内システムとの連携が比較的容易
  * メンテナンス計画などを自分たちで制御できる
* デメリット
  * 機器の調達には数週間～数か月かかることもある
  * ソフトウェアライセンスや機器の購入など初期コストが高い
  * ピーク時に合わせてサイジングする必要があり無駄が多い
  * ディザスタリカバリを考慮すると非常に高額になる

---

### クラウド

* メリット
  * 素早くサーバーを調達できる
  * 初期コストや固定的な保守運用コストを低く抑えられる
  * 実際の負荷に合わせてサーバーの増減やスペックの変更が容易
  * ディザスタリカバリを考慮した構築が容易
* デメリット
  * サービスとして提供されていないものは基本的に使えない
  * クラウド事業者のネットワーク上に置かれるため、要件によってはそもそも利用できない
  * 社内サービスと連携できないこともありうる（VPNを利用することで回避できるケースも多い）
  * クラウド事業者のメンテナンスなど計画外のことも起きる

---

### まとめ

総合的に見てクラウドのメリットは非常に大きいです。
特に耐障害性能という点において、少ないコストで実現でき魅力的です。
一方でコスト見積もりなどをしっかり行ってみると、思っていたよりも安くない場合もよくあります。
オンプレミスとクラウドサービスのメリット・デメリットをしっかりと考慮しましょう。

---

## 構成管理

高信頼性システムを実現するためには単独のサーバーではなく、同じ機能を持ったサーバーを並列に並べることが必要不可欠です。
この時、「同じ構成」のサーバーを追加する際に手作業でやっていては手間もかかりますし、ミスも起きやすくなってしまいます。
ここでは構成管理ツール（プロビジョニングツール）を利用して、少ない手間で同じ構成のサーバーを構築する手法を見ていきましょう。

---

従来のインフラ構築

* あらかじめ手順書やチェックリストを用意
* 対象サーバーにSSHなどで接続し、その手順書にしたがって作業
* 構築が完了できたかを責任者がチェック

問題点

* サーバーの台数が増えると作業に多くの時間がかかる
* 人手による作業は間違えやすい
* 時には、サーバーごとに設定が異なっていたりする

このような状態では障害時に速やかに復旧することができません。

---

というわけで、構成管理ツールの出番

* サーバーの台数によらずセットアップの全自動化
  * 特にこのセットアップの自動化のことをプロビジョニングと呼ぶことが多い
* 人手ではないのでミスはない（はず）
  * もちろん設定は人間がするので、そこにミスがあったらどうしようもない
* 特定のサーバーだけ異なる設定も可能

---

* インフラや設定のコード化
  * 構成管理ツールを使用する際には、サーバーの「あるべき状態」を設定ファイルに記述します
  * ファイルなので、もちろんGitなどのバージョン管理システム（VCS）で管理できます
  * つまりサーバーの状態をバージョン管理することができることになります
  * これはシステム開発の中で培われた、レビューなどを含めたワークフローや履歴管理などをインフラの世界でもできることを意味します
  * またJenkinsなどのCIツールとの連携もできるようになります

---

### 主な構成管理ツール

* Chef
  * エージェントが必要
  * Cookbookを作成する
  * Ruby製
* Ansible
  * エージェントが不要
  * Playbookを作成する
  * Python製
* Itamae
  * エージェントが不要
  * recipeを作成する
  * Ruby製

---

### べき等性

構成管理ツールの特徴の1つとして、何度実行してもOKということがあります。
これは、サーバーを「あるべき状態」にもっていくことが役割だからです。
シェルスクリプトなどで書く場合、条件分岐など作りこむ必要があります。

毎回作り直せばいい

べき等性ってなんだか難しいですね。
そもそも状態を管理するのは面倒なことです。
プロトコルもステートフルよりステートレスの方が分かりやすい。
ところで、クラウドを前提にするとサーバーの再作成も比較的低コストで実現できます。
毎回捨てて作り直せばいつでもクリーンな環境を用意することができます。
Disposable Componentsも似たような意味で使われている。

---

支える技術

* クラウドなどのコンピュータープラットフォーム
* Dockerなどの仮想化技術
* Vagrantなどの仮想環境構築ツール
* Chefなどの構成管理ツール

---

## クラウド入門

---

### クラウドコンピューティング

コンピューター資源の利用方法の1つ。
単にクラウドとも。
2006年ごろから使われだした言葉であるが、インターネットを通じたコンピューター資源の利用ということであれば、それより前から行われていた。
2006年ごろとはちょうど、 Amazon EC2やGoogle App Engineが出てきたころ。

---

### クラウドの分類

提供される形態によって主に3種類に分類できます。

* SaaS（Software as a Service）
  * インターネット経由で、そのまま利用できるアプリケーション（ソフトウェア）としてサービス提供されるもの
  * 古くはASP（Application Service Provider）やユーティリティコンピューティングなどとも呼ばれた由緒正しき（？）形態
* PaaS（Platform as a Service）
  * インターネット経由で、サーバーやデータベースなどのプラットフォームがサービス提供されるもの
* IaaS/HaaS（Infrastracture/Hardware as a Service）
  * インターネット経由で、インフラ/ハードウェアがサービス提供されるもの
  * この分類の中で一番自由度の高い形態

---

### クラウドの物理的なところ

リージョンやゾーンと呼ばれるものは、結局世界のどこかのデーターセンターに実体があります。
そのため洪水や震災などの災害を考えた場合、リージョンやゾーンにまたがってサーバーやデータを冗長化することが高信頼性を考える上では必要となってきます。

### クラウドの組み合わせ

単一のクラウドサービスでもかなりのことができますが、それらを組み合わせることで（例えばAWSとGCPなど）、より障害に強いシステムを作ることができます。

### プラグラマブルなインフラ

サーバーのセットアップを構成管理ツールで自動化できたように、提供されているAPIを利用してクラウドのリソースをプログラムで制御できます。
またサーバーの展開を自動化するようなサービスも提供されています。
