# デバッグ

## XDebug

---

## 概要

デバッグについて学びます。

XDebugのインストールを行います。

デバッグの実行方法を学びます。

---

## デバッグとは

プログラムの不具合のことをバグと呼びます。
プログラム実行時にエラーが出る場合はもちろんですが、エラーが出ない場合でも、プログラムが意図した通りに動作しない場合はバグになります。
デバッグとはバグを取り除く作業のことです。

バグは英語で虫という意味ですが、昔コンピュータの隙間に虫が入り込んで正常に動作しなくなったことがバグという言葉の由来となっています。

---

## デバッグ手法

状況に合わせて様々なデバッグ手法が考えられます。

エラーが発生する場合は、エラーメッセージをよく読み、エラーが発生している行数とエラー内容から解決手法を見つけます。

エラーは発生しないがプログラムが意図した通りに動作しない場合は、以下のようなデバッグ方法が考えられます。
ソースコードを目で確かめてバグを見つける。
echo, var_dumpなどの関数で途中経過を出力しながらバグを見つける。
デバッガを使ってプログラムをステップ実行しながらバグを見つける。

---

## デバッガ

デバッグを支援するためのツールのことをデバッガと呼びます。
多くのプログラミング言語ではその言語に対応したデバッガが用意されています。
PHPも、いくつかのデバッガが存在しますが、最もよく使用されているのは「xdebug」と呼ばれるデバッガです。

---

## デバッグの用語

### ブレークポイント

プログラム実行中に一時できに処理を停止する場所のこと。
ほとんどのIDEで、ソースコードの行数の横に設定することができる。

### ステップ実行

処理を1行ずつ実行すること。

### ステップイン

処理を1行進めること。
関数を呼び出している場合、その関数の中に入り込むことができる。

---

### ステップオーバー

処理を1⾏進めること。
関数を呼び出していても中には⼊りこまない。

### ステップリターン

実行中の関数を最後まで実行し、呼び出しもとに戻る。

### ウォッチ式

デバッグ実行中に参照している変数や式のこと。

ここで紹介した用語は、言語やツールが異なってもデバッグの工程の中でよく使用される用語なので、覚えて理解しておきましょう。

---

## XDebugの導入

### PHPINFOの確認

xdebugでは拡張モジュールをダウンロードする必要がありますが、ダウンロード時にPHPのバージョン情報が必要になるので、まずはPHPINFOを確認します。XAMPPのコントロールパネルからApacheの行のAdminを押下します。

![picture 15](/images/1eed1b0a1ba25299e647430762d6a491c7bfb9cb425121faf71e21386b0f5724.png)  

---

ブラウザでxamppのダッシュボード画面が起動します。
PHPInfoを選択します。

![picture 16](/images/1c5780bcc673576c8dbaf3b1adfd42fe9913ced58f218ff7461b2aaae2c5cdcc.png)  

---

PHPINFOの画面が表示されます。

![picture 17](/images/1fd71f74ccb0bddd251b066c919449e8018171758ab8f28f8fb8b45f66f6d1d6.png)  

---

PHPINFOの画面で「Ctrl + A」（全選択）をして、「Ctrl + C」（コピー）をしておきます。

![picture 18](/images/76c16ba3f749bc994754ef63d872ce4af5de4a7e8c01032d17b47a1cd0f83019.png)  

---

https://xdebug.org/wizard

上記URLにアクセスしてxdebugのウィザード画面を開きます。
先ほどコピーしておいたPHPINFOの情報を貼り付けます。（Ctrl + V）
貼り付けた後に「Analuze …」のボタンを押下します。

![picture 19](/images/e2221a428665e6e0a4b8471013263db41ea5e1f23d0889ad855070ca789dba3a.png)  

---

画面下のInstructionsにxdebug導入方法が表示されるので指示に従ってインストールします。

![picture 20](/images/8c329fcb40f35d928383a5d03c9ebb2c8917f71d56e207f047fc7a2db6e96e88.png)  

拡張モジュールを右クリックし、リンク先の保存を選択します。

---

セキュリティの警告が出る場合がありますが、そのままダウンロードしてください。
ブラウザによって保存方法は異なりますが、「継続」「保存」などを選択してダウンロードします。

ダウンロードしたファイルは「c:¥xampp¥php¥ext」のフォルダに移動させます。
XAMPPのコントロールパネルから、Apacheの行の「config」を選択し、「php.ini」を選択します。
Instructionsに書かれている設定内容をphp.iniの最終行に追加します。

---

その他、いくつかXDebugに関する設定をphp.iniに追加します。
XDebugのバージョン2系と3系で設定内容が変わります。
自身の環境のxdebugのバージョンに合わせて以下をphp.iniの末尾に追加してください。

3系

```ini
[xdebug]
xdebug.mode=debug, develop
xdebug.start_with_request=yes
xdebug.client_port=9003
xdebug.idekey="vscode"
```

2系

```ini
[xdebug]
xdebug.remote_enable=1
xdebug.remote_autostart=1
xdebug.remote_port=9000
xdebug.idekey="vscode"
```

---

設定ファイルのの修正が完了したら、Apacheを再起動（一度停止させて再度開始する）します。
以上でPHPの設定は終了です。

## VS Codeの設定

VS Codeでデバッグを行うには、VS Code側での設定が必要です。

1. 拡張機能のインストール
2. 設定ファイルの作成

---

### 拡張機能のインストール

VS Codeの拡張機能で「PHP Debug」をインストールします。

---

### 設定ファイルの作成

デバッグのマークを押下します。

![picture 21](/images/ad82ebaff0be036a3126579debcd33cb25bf1425d2390154622944839796de55.png)  

「launch.jsonファイルを作成します」を押下します。
クリックするといくつかの選択しが出てくるので、PHPを選択します。

---

以下のような内容のファイルが自動で作成されます。

```json
{
// …
"version": "0.2.0",
"configurations": [
    {
        "name": "Listen for XDebug",
        "type": "php",
        "request": "launch",
        "port": 9000
    },
    {
        "name": "Launch currently open script",
        "type": "php",
        "request": "launch",
        "program": "${file}",
        "cwd": "${fileDirname}",
        "port": 9000
    }
]
}
```

---

xdebugのバージョンが3系の場合は、portを9003にしておいてください。

```json
{
// …
"version": "0.2.0",
"configurations": [
    {
        "name": "Listen for XDebug",
        "type": "php",
        "request": "launch",
        "port": 9003
    },
    {
        "name": "Launch currently open script",
        "type": "php",
        "request": "launch",
        "program": "${file}",
        "cwd": "${fileDirname}",
        "port": 9003
    }
]
}
```

バージョン2系の場合は9000にしておいてください。
これでデバッグの設定は完了です。

---

## デバッグの実行

ブレークポイントを設定し、デバッグを実行します。
PHPのソースコードの行数の左側のをクリックすると、赤いマークがつきます。この赤いマークがついている行がブレークポイントになり、デバッグで実行するとここで処理が一時停止します。

![picture 22](/images/d44e4705c54f0188a6947f0538d6227c1660fe3419e87abb4a8699693235cb3a.png)  

---

デバッグを実行するには、デバッグのメニューを開き、画面上の方にある実行ボタンを押します。
「Listen for XDebug」が選択されていることを確認してください。

![picture 23](/images/ef5d4b9773652f73fd433d72b6e8e763853fed21de06853bda5ea6113e371f48.png)  

---

VS Codeの画面上部に以下のようなメニューが表示されれば正常にデバッグが実行されています。
あとはブラウザから通常通りPHPのコードを実行させます。

![picture 24](/images/570232b969e2ffc9f5fdab00d249cbc85ce9fa509e6b597cf30eea861b30a485.png)  

---

設定に問題がなければ、以下のようにブレークポイントで処理が止まります。

![picture 25](/images/9877eeb02cfd192ba141b050b0f088e2b9059172678e59aa683635f58a8e207d.png)  

---

処理が止まっているときは、変数にカーソルを当てるとその時点での変数の値を確認できます。
画面上部のメニューより、「再開」「ステップオーバー」「ステップイン」「ステップアウト」「再起動」「停止」が行えます。
また、左側のメニューのウォッチ式で、変数以外の式も確認できます。

![picture 26](/images/a0f76be13cca3766b006d8099af3ca4c86a5d17e26a20a1194804e7aff96ed42.png)  

今回はWindows環境でVS Codeによるデバッグの設定を紹介しました。
使用する環境やツールによって細かな設定方法は異なる場合があるため、その都度調べながら実施してください。

---

## まとめ

プログラムの規模が大きくなったり、処理が複雑になればなるほどデバッガは重宝します。
デバッグ力=プログラミング力といっても過言ではないかもしれません。
プログラムのバグの原因がソースコードを見ただけではわかりそうもない、あるいは、処理の流れが複雑で簡単に読み取れない、という場合にはデバッグを活用できるようにしておきましょう。
