# リファクタリング

---

## 概要

* リファクタリングとは何かを学習します。
* リファクタリングの考え方と手法を学びます。

---

## リファクタリングとは

外から見た振る舞いを変えずに、中身のソースコードを修正すること。
リファクタリングの目的のほとんどは、可読性の悪いコードをきれいに整えること。
実行結果は変わらないが、可読性が上がるようにソースコードをいい感じに最適化しましょう！
というのがリファクタリング。

つまり、バグ修正や機能追加などの改修作業はリファクタリングとは言いません。

※パフォーマンスチューニングはリファクタリングと呼ぶかは微妙なところです。
実行結果が変わらないという点ではリファクタリングに分類されますが、
速度が変化するため、ユーザーから見た振る舞いは変化します。
一般にリファクタリングはユーザーには直接的に価値が見えない内部的な改善を指す場合が多いです。

---

そもそも、現状動いてるシステムに対して可読性の低いソースコードは修正した方が良いのでしょうか？

昔は、どんなに汚いコードでも現状で動いているコードは修正せずにそっとしておこう…
というのが、一般的に正しい考えとされていました。

ところが、将来のためには外から見た動作を変更せずに、コードを洗練させた方が良い、という考え方が登場しました。
この考え方がリファクタリングという手法です。

※リファクタリングの原点となる本が出版されたのが2000年。
なので、そのあたりが境界になっていると思われます。

---

## 可読性の高いコードの書き方

そもそも、プログラムを作るとき最初から可読性の高いコードを書けるのであればリファクタリングは不要です。
リファクタリングの手法を知る前にまずは可読性の高いコードを書くための考え方を身につけましょう。
ここではコーディングに関する書籍等でよく紹介されているコーディングに関する考え方をいくつか紹介します。

---

### コードは必ず変更される

プログラミングのソースコードは一度書いたらもう終わりということはほとんどありません。
必ず変更されると心得ておきましょう。
学習用で作成したプログラムの場合、書いて終わりという場合もあり得ますが、実際に稼働しているシステムにおいてはリリース後にも数年にわたりほぼ必ず修正が行われます。
そのため、**変更に強いコードを書くことを意識する**必要があります。

---

### コードは読まれる時間の方が長い

ソースコードは、一般的に書いている時間よりも読まれる時間の方が長いです。
プログラム作成時には、目先のことを考えて書きやすい方で書きたくなりますが、長期的にみるとそれがあだになることもあります。
自分が書いたプログラムも、時間が経てば記憶が薄れて覚えていないことも多いです。
また、自分が書いたプログラムを他人が読むことや、他人が書いたプログラムを自分が読む機会も非常に多いです。
そのため、プログラミングをするときは「書きやすさ」よりも「読みやすさ」を優先する必要があります。

---

### KISSの原則

Keep It Simple, Stupid.または　Keep It Short and Simple. の略です。
直訳すると「シンプルにしておけ、愚か者よ」。または「簡潔かつ単純にしておけ」。
「将来に備えて」などと考えて本当は必要のない余計なコードを書いてしまうと、コードはどんどん複雑になっていきます。
余計なことはせず、シンプルなコードを保つように心掛けましょう、という意味です。

プログラムというのは一度リリースしても、その後何度も機能追加されていきます。
しかし、「要件にないが将来こういう機能が追加されるだろう」と推測して作った機能は、ほとんどの確率で使われることはないんだそうです。

可読性が高く保てるようにシンプルにすることは大事ですが、推測で必要になりそうな機能を勝手に追加しても良いことはないんだそう。

---

### DRY原則

Don't Repeat Yourself. の略で、直訳すると「繰り返してはいけない。」
コードをコピペして重複させないようにしましょうということです。
重複は、バグ修正、機能追加の際のリスクになります。
処理だけでなく、定数やリテラルも重複しないように注意しましょう。
また、コードをそのまま説明しているコメントも重複と同じです。

コードの中に重複があると、修正が必要になった場合に修正個所の特定が難しく、そのうち整合性が保てなくなる可能性があります。
そのようなリスクがある部分は重複しないようにメソッド化、クラス化、モジュール化して共通化することが必要です。

---

### 名前重要

プログラミングは、コードの命名が最重要課題だとも言われています。
変数名、メソッド名、クラス名、などプログラミングでは必ず名前を付ける場面が多くあります。
ソースコードの中で命名された名前はそのまま可読性に影響します。
名前が適切かどうかを常に意識してプログラムを書くことを心がけましょう。

---

### コメントの書き方

可読性においてはコメントの書き方も重要です。
コメントの目的は、書き手の意図を知らせることです。
読み手がコードの理解に役に立つことを書くようにします。
コードを読めばすぐにわかることは、コメントには書かないようにします。

処理が何をしているのか（What）は基本的にコードを読めば分かります。
しかし、なぜその処理をしているのか、なぜその手法で実現しているのか（Why）に関しては、コードを書いた人しか分からない場合があります。
一般にコメントではWhatは不要で、Whyの理由を書くことが重要です。

---

### 関数(メソッド)の行数

一つの関数やメソッドは何行程度で書くのが良いでしょうか。

Javaの場合、標準ライブラリに含まれているメソッドの8割以上は20行以下になっているそうです。
また、「プログラマーが知るべき97のこと」では5～10行がベストだと書かれています。

関数の行数を何行にするべきかは一概には言ませんが、長すぎる関数やメソッドは可読性やメンテナンス性を下げます。
また、バグの温床にもなりやすいです。
できる限り少なく書けるように工夫しましょう。

---

### コードの書き方・考え方に関する本

コーディングに関する書籍や、プログラミングにおける思想に関する書籍も多く出版されています。
プログラミングの基本を身につけた後は、何冊か読んでみることをおすすめします。

[リーダブルコード](https://www.oreilly.co.jp/books/9784873115658/)

[達人プログラマー](https://www.ohmsha.co.jp/book/9784274226298/)

[プリンシプルオブプログラミング](https://www.shuwasystem.co.jp/book/9784798046143.html)

---

### ここまでの

* ソースコードは、読まれる時間が長く、必ず変更されるものと心得る
* 重複を排除して読みやすいソースコードを書く。そして余計なソースは記述しない
* 分かりやすい名前をつける
* コメントは必要最低限にする

---

## リファクタリング

### リファクタリングの定義

リファクタリングの定義は「外部から見たプログラムの振る舞いを変えずに、プログラムの内部構造を改善すること」になります。

先にも述べましたが、バグを修正することはリファクタリングとはなりません。
また、機能の追加もリファクタリングには含まれません。

リファクタリングをすると、結果的にバグ修正や機能追加が行いやすくなります。
これがリファクタリングの目的です。

リファクタリングは直接ユーザーに影響を与えることは少ないですが、
将来自分たちを助けることになる可能性が高いです。
つまり、リファクタリングはシステム開発における投資とも考えられます。

---

### リファクタリングの注意点

**リファクタリングと機能追加やバグ改修を同時に行ってはいけません。**

リファクタリングはその定義から、プログラムの修正前と修正後で見た目の振る舞いが変化しないことが求められます。
機能追加やバグ修正は、見た目の動きを変化させてしまうため、同時に作業を行うとリファクタリングが正しく行われたのかが分からなくなります。
そのため、機能追加やバグ修正とは切り分けて作業を行うことが求められています。

見た目の動きが変わらずにプログラムを修正できたを保証するためには以下のことが重要になります。

* テストが用意されているか確認する。
* できるかぎり頻繁にテストを行う。
* 作業を小さな単位にまとめて、慎重に作業を行う。

理想は、ユニットテストツールなどが用意されていて、関数やクラス単位で再テストが容易な環境が作られていることです。
プログラムを修正するということは、新たなバグを生んでしまう可能性や、動きが変わってしまう可能性も十分にあります。
そうならないためには細かくテストを行いながら作業することが重要になります。

---

### リファクタリングの対象

書籍「[達人プログラマー](https://www.ohmsha.co.jp/book/9784274226298/)」では、以下がリファクタリングの対象になると述べています。

* 二重化しているコードを発見した（DRY原則に反している）
* 関係ないもの同士が影響し合っている。
* 時代遅れの技術が使われている。
* パフォーマンスが悪い

---

また、「[Java言語で学ぶリファクタリング入門](https://www.sbcr.jp/product/4797337990/)」では、リファクタリングの可能性が潜んでいる部分のことを「不吉な匂い」と呼び、以下の22個を上げています。

* コードが重複している
* メソッドが長すぎる
* クラスの持つフィールドやメソッドが多すぎる
* メソッドの引数が多すぎる
* 仕様変更の修正箇所があちこちに散らばっている
* あるクラスを修正すると、他のクラスも修正しなければならない
* 他のクラスの中身をいじっているクラスがある
* まとめて扱うべきデータが1つのクラスにまとまっていない
* クラスを使わず、int型のような基本データ型ばかり使っている
* switch文やif文を使って振る舞いを分けている
* サブクラスを作ると、別のところにもサブクラスを作らなければならない
* クラスが大して仕事をしていない
* 拡張するだろうと期待して、クラスが一般化しすぎている
* 一時的にしか使わないフィールドがある
* メソッド呼び出しの連鎖が多すぎる
* 委譲ばかりしていて、自分では仕事をしていないクラスがある
* 必要のない双方向リンクや、IS-A関係の成り立たない継承がある
* クラスのインターフェースが不適切
* 既存のクラスライブラリが使いにくい
* フィールドとアクセッサしかもっていないクラスがある
* 継承しているメソッドなのに、それを呼ぶと問題が起きる
* コードの不備を補うために、詳しいコメントがある

---

かなり細かく分けて紹介されていますが、ざっくりまとめると

* 理解しにくい
* 修正しにくい
* 拡張しにくい
* 無駄なコードがある

と感じる部分がリファクタリングの対象になると考えて良いでしょう。

---

### リファクタリングの手順

1. テストを実施してテストを通ることを確認
    テストが用意されていない場合は、テストの作成から行う。
    テストがないコードに関しては、リファクタリングはするべきではない。
2. コードの修正を実施
3. テストを実施してテストが通ることを確認
4. 2と3の手順を繰り返す。
    たくさんのコードを一気に修正しないように注意する。
    リファクタリングは「小さな修正 ⇒ テスト」のサイクルを多く繰り返し、
    少しずつ実施していく。

---

### リファクタリングをどこまでやるべきか

システム開発を行う上でリファクタリングは大事な概念ですが、必ずしも実施した方が良いとは限りません。

業務での開発には納期があるため、時間の制約があります。
時間が許すのであれば、ソースコードをきれいに保つに越したことはありませんが、時間の許容範囲と、既存のプログラムを修正することのリスクのバランスを取ってどこまで実施するかを判断することが大事です。

---

## 全体のまとめ

* リファクタリングは必ずしも実施したほうが良いわけではありません。状況に応じて適切な判断を下しましょう。
* リファクタリングの必要がない、読みやすい、かつ拡張しやすいコードを書けるように心がけましょう。
* 時間と心に余裕があればリファクタリング積極的にリファクタリングしていきましょう。
* リファクタリングは繰り返しテストしながら小さく進めましょう。

