# DB_練習問題8

---

## 実践SQL

以下のテーブルを使用します。

* 商品カテゴリ(category)
* 商品(products)
* 顧客(customer)
* 仕入先(supplier)
* 販売(sales)
* 購買(purchases)
* 商品_複数(products_munlti)

---

下記のSQLを実行し、テーブルとテストデータを作成しておいてください。
接続するDBとユーザーは任意です。

```sql
-- テーブル削除
drop table if exists category;
drop table if exists products;
drop table if exists customer;
drop table if exists supplier; 
drop table if exists sales;
drop table if exists purchases;
drop table if exists products_multi; 

-- 商品カテゴリ
CREATE TABLE category (
    category_id int primary key
    , category_name varchar(50)
);

-- データ作成
insert into category values (1, '食品');
insert into category values (2, '日用品');
insert into category values (3, '雑貨');


-- 商品テーブル
create table products (
    products_id int primary key
    , products_name varchar(50)
    , category_id int
    , p_price real
    , s_price real
);

-- データ作成
insert into products values (1, 'りんご', 1, 100, 120);
insert into products values (2, 'みかん', 1, 120, 150);
insert into products values (3, 'バナナ', 1, 240, 300);
insert into products values (4, 'ボールペン', 2, 260, 300);
insert into products values (5, 'ティッシュ', 2, 180, 250);
insert into products values (6, '電池', 2, 370, 400);
insert into products values (7, 'コップ', 3, 600, 700);
insert into products values (8, '椅子', 3, 1700, 2000);
insert into products values (9, '地球儀', 3, 4100, 5000);


-- 顧客テーブル
create table customer (
    customer_id int primary key
    , customer_name varchar(50)
);

-- データ作成
insert into customer values (1, '川上商店');
insert into customer values (2, '中山商事');

-- 仕入れ先テーブル
create table supplier (
    supplier_id int primary key
    , supplier_name varchar(50)
);

-- データ作成
insert into supplier values (1, '仕入れ先A');
insert into supplier values (2, '仕入れ先B');

-- 販売テーブル
create table sales (
    sales_id int primary key
    , customer_id int
    , sales_date date
    , products_id int
    , unit_sales real
);
create index sales_products on sales (products_id);

-- データ作成
insert into sales values(1, 1, '2018-07-01', 1, 7);
insert into sales values(2, 1, '2018-07-04', 2, 12);
insert into sales values(3, 1, '2018-07-05', 4, 4);
insert into sales values(4, 1, '2018-07-09', 6, 1);
insert into sales values(5, 1, '2018-07-15', 8, 2);
insert into sales values(6, 1, '2018-07-19', 9, 1);
insert into sales values(7, 1, '2018-07-20', 1, 15);
insert into sales values(8, 1, '2018-08-10', 2, 20);
insert into sales values(9, 1, '2018-08-20', 8, 2);
insert into sales values(10, 1, '2018-09-03', 4, 7);

insert into sales values(11, 2, '2018-07-05', 1, 11);
insert into sales values(12, 2, '2018-07-16', 2, 7);
insert into sales values(13, 2, '2018-07-25', 4, 10);
insert into sales values(14, 2, '2018-08-15', 7, 8);
insert into sales values(15, 2, '2018-08-25', 1, 5);
insert into sales values(16, 2, '2018-09-01', 2, 8);
insert into sales values(17, 2, '2018-09-03', 9, 1);
insert into sales values(18, 2, '2018-09-05', 8, 5);
insert into sales values(19, 2, '2018-09-10', 6, 2);
insert into sales values(20, 2, '2018-09-21', 2, 10);

-- 仕入れテーブル
create table purchases (
    purchases_id int primary key
    , supplier_id int 
    , purchases_date date
    , products_id int
    , unit_purchases real
);

-- データ作成
insert into purchases values(1, 1, '2018-07-01', 1, 50);
insert into purchases values(2, 1, '2018-07-01', 2, 50);
insert into purchases values(3, 1, '2018-07-01', 3, 50);
insert into purchases values(4, 1, '2018-07-01', 4, 50);
insert into purchases values(5, 1, '2018-07-01', 5, 50);
insert into purchases values(6, 1, '2018-07-01', 6, 50);
insert into purchases values(7, 1, '2018-07-01', 7, 50);
insert into purchases values(8, 1, '2018-07-01', 8, 50);
insert into purchases values(9, 1, '2018-07-01', 9, 50);


-- 1レコードで複数のデータを持つ
-- MySQLの場合は「::text」は不要
create table products_multi as
select 1 id1, 'リンゴ'::text name1, 100 price1
 , 2 id2, 'みかん'::text name2, 200 price2
 , 3 id3, 'バナナ'::text name3, 300 price3;
```

---

### 問題（1. 名称の表示）

販売(sales)のデータに顧客名、商品名、商品単価が取得できるSQL文を作成してください。並び順は販売日付の昇順

対象テーブル：商品(products), 販売(sales), 顧客(customer)

期待する結果

|顧客名|商品名|販売日付|販売単価|販売個数|
|:--|:--|:--|:--|:--|
| 川上商店 | りんご     | 2018-07-01 |      120 |        7 |
| 川上商店 | みかん     | 2018-07-04 |      150 |       12 |
| 中山商事 | りんご     | 2018-07-05 |      120 |       11 |
| 川上商店 | ボールペン | 2018-07-05 |      300 |        4 |
| 川上商店 | 電池       | 2018-07-09 |      400 |        1 |
| 川上商店 | 椅子       | 2018-07-15 |     2000 |        2 |
| 中山商事 | みかん     | 2018-07-16 |      150 |        7 |
| 川上商店 | 地球儀     | 2018-07-19 |     5000 |        1 |
| 川上商店 | りんご     | 2018-07-20 |      120 |       15 |
| 中山商事 | ボールペン | 2018-07-25 |      300 |       10 |
| 川上商店 | みかん     | 2018-08-10 |      150 |       20 |
| 中山商事 | コップ     | 2018-08-15 |      700 |        8 |
| 川上商店 | 椅子       | 2018-08-20 |     2000 |        2 |
| 中山商事 | りんご     | 2018-08-25 |      120 |        5 |
| 中山商事 | みかん     | 2018-09-01 |      150 |        8 |
| 川上商店 | ボールペン | 2018-09-03 |      300 |        7 |
| 中山商事 | 地球儀     | 2018-09-03 |     5000 |        1 |
| 中山商事 | 椅子       | 2018-09-05 |     2000 |        5 |
| 中山商事 | 電池       | 2018-09-10 |      400 |        2 |
| 中山商事 | みかん     | 2018-09-21 |      150 |       10 |

---

### 問題（2. 商品ごとの販売数）

販売(sales)を元に、商品ごとの販売合計個数を取得するSQL文を作成してください。

対象テーブル：商品(products), 販売(sales)

期待する結果

| 商品名     | 販売単価 | 販売個数 |
|:--|--:|--:|
| りんご     |      120 |       38 |
| みかん     |      150 |       57 |
| ボールペン |      300 |       21 |
| 電池       |      400 |        3 |
| コップ     |      700 |        8 |
| 椅子       |     2000 |        9 |
| 地球儀     |     5000 |        2 |

---

### 問題（3. 販売金額が1万円以上の商品）

販売(sales)を元に、販売金額が1万円以上の商品を取得するSQL文を作成してください。

対象テーブル：商品(products), 販売(sales)

期待する結果

| 商品名 | 販売単価 | 販売個数 | 販売金額 |
|:--|--:|--:|--:|
| 椅子   |     2000 |        9 |    18000 |
| 地球儀 |     5000 |        2 |    10000 |

---

### 問題（4. 取引履歴）

仕入と売上を同時に取得するSQL文を作成してください。
並び順は取引日付の昇順とする。

対象テーブル：販売(sales), 購買(purchases), 商品(products)

期待する結果

| 取引名 | 取引日付   | 商品名     | 数量 |
|:--|:--|:--|--:|
| 仕入   | 2018-07-01 | 電池       |   50 |
| 売上   | 2018-07-01 | りんご     |    7 |
| 仕入   | 2018-07-01 | ティッシュ |   50 |
| 仕入   | 2018-07-01 | ボールペン |   50 |
| 仕入   | 2018-07-01 | バナナ     |   50 |
| 仕入   | 2018-07-01 | みかん     |   50 |
| 仕入   | 2018-07-01 | りんご     |   50 |
| 仕入   | 2018-07-01 | 地球儀     |   50 |
| 仕入   | 2018-07-01 | 椅子       |   50 |
| 仕入   | 2018-07-01 | コップ     |   50 |
| 売上   | 2018-07-04 | みかん     |   12 |
| 売上   | 2018-07-05 | ボールペン |    4 |
| 売上   | 2018-07-05 | りんご     |   11 |
| 売上   | 2018-07-09 | 電池       |    1 |
| 売上   | 2018-07-15 | 椅子       |    2 |
| 売上   | 2018-07-16 | みかん     |    7 |
| 売上   | 2018-07-19 | 地球儀     |    1 |
| 売上   | 2018-07-20 | りんご     |   15 |
| 売上   | 2018-07-25 | ボールペン |   10 |
| 売上   | 2018-08-10 | みかん     |   20 |
| 売上   | 2018-08-15 | コップ     |    8 |
| 売上   | 2018-08-20 | 椅子       |    2 |
| 売上   | 2018-08-25 | りんご     |    5 |
| 売上   | 2018-09-01 | みかん     |    8 |
| 売上   | 2018-09-03 | 地球儀     |    1 |
| 売上   | 2018-09-03 | ボールペン |    7 |
| 売上   | 2018-09-05 | 椅子       |    5 |
| 売上   | 2018-09-10 | 電池       |    2 |
| 売上   | 2018-09-21 | みかん     |   10 |

---

### 問題（5. 在庫数）

商品ごとの在庫数（仕入数 – 売上数）を取得するSQLを作成してください。

対象テーブル：販売(sales), 購買(purchases), 商品(products)

期待する結果

| 商品名     | 在庫数 |
|:--|--:|
| りんご     |                               12 |
| みかん     |                               -7 |
| バナナ     |                               50 |
| ボールペン |                               29 |
| ティッシュ |                               50 |
| 電池       |                               47 |
| コップ     |                               42 |
| 椅子       |                               43 |
| 地球儀     |                               49 |

---

### 問題（6. 商品の組み合わせ）

商品テーブル(products)から、商品の組み合わせを出力するSQLを作成してください。（図は一部抜粋）

対象テーブル：商品(products)

期待する結果

| products_name | products_name |
|:--|:--|
| みかん        | りんご        |
| バナナ        | みかん        |
| バナナ        | りんご        |
| ボールペン    | りんご        |
| ボールペン    | バナナ        |
| ボールペン    | みかん        |
| ティッシュ    | バナナ        |
| ティッシュ    | みかん        |
| ティッシュ    | ボールペン    |
| ティッシュ    | りんご        |
| 電池          | みかん        |
| 電池          | ボールペン    |
| 電池          | りんご        |
| 電池          | バナナ        |
| 電池          | ティッシュ    |
| コップ        | ティッシュ    |
| コップ        | みかん        |
| コップ        | ボールペン    |
| コップ        | りんご        |
| コップ        | 電池          |
| コップ        | バナナ        |
| 椅子          | コップ        |
| 椅子          | ボールペン    |
| 椅子          | りんご        |
| 椅子          | 電池          |
| 椅子          | バナナ        |
| 椅子          | ティッシュ    |
| 椅子          | みかん        |
| 地球儀        | 椅子          |
| 地球儀        | ティッシュ    |
| 地球儀        | みかん        |
| 地球儀        | コップ        |
| 地球儀        | ボールペン    |
| 地球儀        | りんご        |
| 地球儀        | 電池          |
| 地球儀        | バナナ        |

---

### 問題（7. 販売が存在するデータ）

一度でも販売されたことのある商品(salesにデータがある)を取得するSQL文を作成してください。

対象テーブル」商品(products), 販売(sales)

期待する結果

| products_id | products_name | category_id | p_price | s_price |
|:--|:--|:--|--:|--:|
|           1 | りんご        |           1 |     100 |     120 |
|           2 | みかん        |           1 |     120 |     150 |
|           4 | ボールペン    |           2 |     260 |     300 |
|           6 | 電池          |           2 |     370 |     400 |
|           7 | コップ        |           3 |     600 |     700 |
|           8 | 椅子          |           3 |    1700 |    2000 |
|           9 | 地球儀        |           3 |    4100 |    5000 |

---

### 問題（8. 販売が存在しないデータ）

一度も販売されていない商品(salesにデータがない)を検索するSQL文を作成してください。

対象テーブル：商品(products), 販売(sales)

期待する結果

| products_id | products_name | category_id | p_price | s_price |
|:--|:--|--:|--:|--:|
|           3 | バナナ        |           1 |     240 |     300 |
|           5 | ティッシュ    |           2 |     180 |     250 |

---

### 問題（9. 月別の販売合計金額）

月単位の売上合計金額を取得するSQL文を作成してください。

対象テーブル：商品(products), 販売(sales)

期待する結果

|売上月|売上金額|
|:--|--:|
|2018-07|20410|
|2018-08|13200|
|2018-09|20600|

---

### 問題（10. ランク別商品件数）

商品を単価の値によって分類し、その商品が何アイテムあるかをカウントするSQL文を作成してください。

対象テーブル：商品(products)

期待する結果

| ランク    | count |
|:--|--:|
| 0～300    |        5 |
| 1000～    |        2 |
| 300～1000 |        2 |

---

### 問題（11. 縦から横）

商品カテゴリを1レコードにまとめて取得するSQL文を作成してください。

対象テーブル：商品カテゴリ(category)

期待する結果

| カテゴリ1 | カテゴリ2 | カテゴリ3 |
|:--|:--|:--|
| 食品      | 日用品    | 雑貨      |

---

### 問題（12. 月別カテゴリ別販売合計金額）

月単位で、カテゴリ別の売上合計金額を取得するSQL文を作成してください。

対象テーブル：販売(sales), 商品(products)商品

|売上月|食品売上|日用品売上|雑貨売上|
|:--|--:|--:|--:|
|2018-07|6810|4400|9000|
|2018-08|3600|0|9600|
|2018-09|2700|2900|15000|

---

### 問題（13. 横から縦）

1レコードに複数の情報を持つテーブルに対して

|id1|name1|price1|id2|name2|price2|id3|name3|price3|
|:--|:--|:--|:--|:--|:--|:--|:--|:--|
|1|りんご|200|2|みかん|200|3|バナナ|300|

以下のように、複数のレコードに分けて取得できるようなSQL文を作成してください。

対象テーブル：商品_複数(products_multi)

| id   | name   | price |
|--:|--:|--:|
|    1 | リンゴ |   100 |
|    2 | みかん |   200 |
|    3 | バナナ |   300 |

---

### 問題（14. 商品単価順）

products(商品)をs_price(販売単価)の安い順にランク付けするSQL文を作成してください。

対象テーブル：商品(products)

期待する結果

| products_name | price | rank |
|:--|--:|--:|
| りんご        |   120 |    1 |
| みかん        |   150 |    2 |
| ティッシュ    |   250 |    3 |
| バナナ        |   300 |    4 |
| ボールペン    |   300 |    4 |
| 電池          |   400 |    6 |
| コップ        |   700 |    7 |
| 椅子          |  2000 |    8 |
| 地球儀        |  5000 |    9 |

---

### 問題（15. 顧客別日付別売上ランキング）

顧客・日付単位で、購売上金額のランキングを出力するSQLを作成してください。

対象テーブル：販売(sales), 商品(products), 顧客(customer)

| customer_name | sales_date | products_name | 購入金額 | rank() over(partition by s.customer_id order by (unit_sales * p_price) desc) |
|:--|:--|:--|:--|:--|
| 川上商店      | 2018-07-19 | 地球儀        |     4100 | 1 |
| 川上商店      | 2018-07-15 | 椅子          |     3400 | 2 |
| 川上商店      | 2018-08-20 | 椅子          |     3400 | 2 |
| 川上商店      | 2018-08-10 | みかん        |     2400 | 4 |
| 川上商店      | 2018-09-03 | ボールペン    |     1820 | 5 |
| 川上商店      | 2018-07-20 | りんご        |     1500 | 6 |
| 川上商店      | 2018-07-04 | みかん        |     1440 | 7 |
| 川上商店      | 2018-07-05 | ボールペン    |     1040 | 8 |
| 川上商店      | 2018-07-01 | りんご        |      700 | 9 |
| 川上商店      | 2018-07-09 | 電池          |      370 | 10 |
| 中山商事      | 2018-09-05 | 椅子          |     8500 | 1 |
| 中山商事      | 2018-08-15 | コップ        |     4800 | 2 |
| 中山商事      | 2018-09-03 | 地球儀        |     4100 | 3 |
| 中山商事      | 2018-07-25 | ボールペン    |     2600 | 4 |
| 中山商事      | 2018-09-21 | みかん        |     1200 | 5 |
| 中山商事      | 2018-07-05 | りんご        |     1100 | 6 |
| 中山商事      | 2018-09-01 | みかん        |      960 | 7 |
| 中山商事      | 2018-07-16 | みかん        |      840 | 8 |
| 中山商事      | 2018-09-10 | 電池          |      740 | 9 |
| 中山商事      | 2018-08-25 | りんご        |      500 | 10 |

---

### 問題（16. 古いデータ）

販売テーブル(sales)から、商品ごとの販売日が一番古いデータを出力するSQLを作成してください。

対象テーブル：商品(products), 販売(sales)

期待する結果

| products_name | sales_date | rownum |
|:--|:--|:--|
| りんご        | 2018-07-01 |      1 |
| みかん        | 2018-07-04 |      1 |
| ボールペン    | 2018-07-05 |      1 |
| 電池          | 2018-07-09 |      1 |
| コップ        | 2018-08-15 |      1 |
| 椅子          | 2018-07-15 |      1 |
| 地球儀        | 2018-07-19 |      1 |
