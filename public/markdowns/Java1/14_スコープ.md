# スコープ

---

Webシステムにおいて、クライアントとAPサーバー間でやり取りされる値の寿命をスコープといいます。
Java EEにおいては4種類のスコープが定義されています。

1. ページスコープ
2. リクエストスコープ
3. セッションスコープ
4. アプリケーションスコープ

---

サンプルプログラム（scope.jsp）を確認してください。

```html
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>スコープの確認</title>
</head>
<body>
<%
// pageContext.removeAttribute("value");
// request.removeAttribute("value");
// session.removeAttribute("value");
// application.removeAttribute("value");

String ps = (String) pageContext.getAttribute("value");
if (ps == null) {
    ps = "";
}
ps += "a";
out.println("ページ：" + ps + "<br>");
pageContext.setAttribute("value", ps);

String rs = (String) request.getAttribute("value");
if (rs == null) {
    rs = "";
}
rs += "a";
out.println("リクエスト：" + rs + "<br>");
request.setAttribute("value", rs);

String ss = (String) session.getAttribute("value");
if (ss == null) {
    ss = "";
}
ss += "a";
out.println("セッション：" + ss + "<br>");
session.setAttribute("value", ss);

String as = (String) application.getAttribute("value");
if (as == null) {
    as = "";
}
as += "a";
out.println("アプリケーション：" + as + "<br>");
application.setAttribute("value", as);
%>
</body>
</html>
```

---

「scope.jsp」を実行して、以下のような結果になることを確認してください。

結果

```text
ページ:a
リクエスト：a
セッション：a
アプリケーション：a
```

再読み込みを行って、以下のような結果になることを確認してください。

```text
ページ:a
リクエスト：a
セッション：aa
アプリケーション：aa
```

---

続いて「Google Chrome」などのブラウザで、eclipseで実行したURLと同じURLにアクセスして、以下のような結果になることを確認してください。

```text
ページ:a
リクエスト：a
セッション：a
アプリケーション：aaa
```

再読み込みを行って、以下のような結果になることを確認してください

```text
ページ:a
リクエスト：a
セッション：aa
アプリケーション：aaaa
```

---

それぞれのスコープを実行すると、以下のような結果を確認できます。

eclipse

```text
ページ：a
リクエスト：a
セッション：aa
アプリケーション：aa
```

Chrome

```text
ページ：a
リクエスト：a
セッション：aa
アプリケーション：aaaa
```

それぞれのスコープの特徴を確認します。

---

## セッション

まず一番大事なところの、セッションスコープ（単にセッションともいう）を確認します。

今まで、画面遷移をする際には、全ての情報をクライアントとAPサーバーの間でやりとりしていました。
セッションを利用することで、必要な情報をAPサーバーに保持させることができます。
セッションを利用することで、APサーバーのプログラムからいつでも必要な情報にアクセスすることができるようになります。

![picture 8](/images/fc3696f2a49cefed9b7a7aa307eef76533a937de396334b6a5a7c1de6a502a89.png)  

---

クライアントとAPサーバーとのやり取りは全て独立して行われます（これをステートレスといいます）。

![picture 9](/images/268ee376d0d69758cc0388c38e9117b5f52ebbf9e965d884afd1ed749bec849b.png)  

---

セッションという仕組みは、HTTPというステートレスなプロトコルの上で、状態を管理できるようにする仕組みです。
そのため画面遷移など、複数のリクエストをまたいで、情報を保持し続けることができるようになります。

![picture 10](/images/cf5340994a80f2447bcdbbb1b0987ea8c109676a8b449243ed0ab697cbde9ffd.png)  

---

このセッションを実現するために、各クライアントに対してIDを発行し、サーバーではこの「セッションID」と「保持するデータ」をペアにして管理します。

![picture 11](/images/84240d3a3513645941f1236a9d34b5cbe4e8962f7853204e010d71d2c2bdf91c.png)  

そのため、複数のクライアントが同時にアクセスしていても、紐付く情報は別のセッションとなります。

仕組みとしてはセッションが一番複雑なため先に説明しました。
続いて、実際のプログラムを確認しながら、スコープの動作を見ていきます。

---

## ページスコープ

スコープを使ったプログラムを確認します。
まずはページスコープからです。

```java
String ps = (String) pageContext.getAttribute("value");
if (ps == null) {
    ps = "";
}
ps += "a";
out.println("ページ：" + ps + "<br>");
pageContext.setAttribute("value", ps);
```

ページスコープにアクセスするにはpageContextというオブジェクトを利用します。

getAttributeメソッドで値を取得できます。
スコープにはどんな型の値でも保存できる代わりに、取得時に元の型にキャストする必要があります。
このプログラムでは「value」という名前で保存した値を取得しています。

スコープに保存されていない名前を指定した場合、戻り値はnullとなるため、空文字列をセットしています。

変数ps（ページスコープから取り出した値）に「a」を1文字追加しています。
そしてその値を出力しています。

最後にsetAttributeメソッドで、1文字増やした値を、ページスコープに保存しています。
スコープに値を保存するには、(保存する値の名前, 保存する値)というように、名前と値をセットで引数に指定する必要があります。

---

## リクエストスコープ

次にリクエストスコープですが、基本的にやっていることはページスコープと同じです。

```java
String rs = (String) request.getAttribute("value");
if (rs == null) {
    rs = "";
}
rs += "a";
out.println("リクエスト：" + rs + "<br>");
request.setAttribute("value", rs);
```

リクエストスコープにアクセスするにはrequestというオブジェクトを利用します。
ページスコープと同様に、getAttributeメソッドで値を取得できます。
また取得時には、元の型にキャストする必要があります。
このプログラムでは「value」という名前で保存した値を取得しています。
スコープに保存されていない名前を指定した場合、戻り値はnullとなるため、空文字列をセットしています。

変数rs（リクエストスコープから取り出した値）に「a」を1文字追加しています。
そしてその値を出力しています。
最後にsetAttributeメソッドで、1文字増やした値を、リクエストスコープに保存しています
スコープに値を保存するには、(保存する値の名前, 保存する値)というように、名前と値をセットで引数に指定する必要があります

---

ページスコープとリクエストスコープの違いは、JSPファイル1つだけでは分かりません。
複数のJSPファイルを使用したときに、違いを見つけることができます。

ページスコープはJSPファイルの数だけ存在します。
またレスポンスするとデータはクリアされます。
リクエストスコープはリクエストしてレスポンスするまでで1つだけ存在します。
こちらもレスポンスするとデータはクリアされます。

![picture 12](/images/9bcee5b95be622ba0c89c08255bfac1e056d8de66ce24ef921acc9bc7db60cbd.png)  

1回のリクエスト処理の中で、複数ファイルで値を共有したいというときに、リクエストスコープを利用します。

---

## セッションスコープ

次はセッションスコープです。

```java
String ss = (String) session.getAttribute("value");
if (ss == null) {
    ss = "";
}
ss += "a";
out.println("セッション：" + ss + "<br>");
session.setAttribute("value", ss);
```

やっていることはページスコープとリクエストスコープと同じです。
セッションスコープにアクセスするにはsessionというオブジェクトを利用します。
getAttributeメソッドで値を取得することができ、取得時には元の型にキャストする必要があります。
このプログラムでは「value」という名前で保存した値を取得しています。
スコープに保存されていない名前を指定した場合、戻り値はnullとなるため、空文字列をセットしています。
ただしこれまでと違い、このプログラムのこの処理が実行されるのは各クライアントにつき一度だけです。

変数ss（セッションスコープから取り出した値）に「a」を1文字追加しています。
そしてその値を出力しています。
セッションなのでどんどん文字列が長くなっていきます。
最後にsetAttributeメソッドで、1文字増やした値を、セッションスコープに保存しています。
スコープに値を保存するには、(保存する値の名前, 保存する値)というように、名前と値をセットで引数に指定する必要があります。

---

セッションの仕組みは先ほど説明した通りです。
Javaではこのようなプログラムを書くことによって、簡単にセッション機能を利用できます。

リクエストスコープはリクエストの回数だけ存在します。
レスポンスするとデータはクリアされます。
セッションスコープはクライアントの数だけ存在します。
レスポンスしてもデータはクリアされません。

---

## アプリケーションスコープ

最後にアプリケーションスコープです。

```java
String as = (String) application.getAttribute("value");
if (as == null) {
    as = "";
}
as += "a";
out.println("アプリケーション：" + as + "<br>");
application.setAttribute("value", as);
```

やっていることは他のスコープと変わりません。
アプリケーションスコープにアクセスするにはapplicationというオブジェクトを利用します。

getAttributeメソッドで値を取得することができ、取得時には元の型にキャストする必要があります。
このプログラムでは「value」という名前で保存した値を取得しています。

スコープに保存されていない名前を指定した場合、戻り値はnullとなるため、空文字列をセットしています。
ただしこれまでと違い、このプログラムのこの処理が実行されるのはサーバーを起動してから一度だけです。

---

変数as（アプリケーションスコープから取り出した値）に「a」を1文字追加しています。
そしてその値を出力しています。
どんどん文字列が長くなっていきます。

最後にsetAttributeメソッドで、1文字増やした値を、アプリケーションスコープに保存しています。
スコープに値を保存するには、(保存する値の名前, 保存する値)というように、名前と値をセットで引数に指定する必要があります。

アプリケーションスコープもセッションスコープと同じように、何度リクエストをしても値は共有されています。
さらに、セッションとは違い、サーバーで1つしか存在しません。
全ユーザーでアプリケーションスコープは共有されます。

セッションスコープはクライアントの数だけ存在します。
レスポンスしてもデータはクリアされません。
アプリケーションスコープはサーバーに1つだけ存在します。
レスポンスしてもデータはクリアされません。

---

## スコープ-まとめ

* ページスコープ
  * 同一のJSPファイル内でデータを共有します
  * レスポンスするとデータはクリアされます
* リクエストスコープ
  * 同一クライアント/ブラウザ別に、1回のリクエスト内でデータを共有します
  * レスポンスするとデータはクリアされます
* セッションスコープ
  * 同一クライアント/ブラウザー別に、複数のリクエストをまたいでデータを共有します
  * 一定時間、クライアントからの接続がないとデータは自動的にクリアされます
  * web.xmlというファイルで設定でき、デフォルトは30分です
  * removeAttributeメソッドやinvalidateメソッドで明示的にクリアできます
* アプリケーションスコープ
  * Webアプリケーション全体でデータを共有します
  * サーバーを再起動するとデータは自動的にクリアされます
  * removeAttributeメソッドで明示的にクリアできます

---

セッションスコープやアプリケーションスコープは確かに便利な機能ですが、多用しすぎるとサーバーのメモリを圧迫しかねません。
変数のスコープでも同様ですが、必要最小限のスコープを利用することがよい設計に繋がります。

---

## クッキー

続いて、クッキーというものについて確認します。
クッキー（Cookie）はセッションとよく似ており、セッションと同じように情報を保持するものです。
しかし、「クライアント側に保持される」という点で大きく異なります。

![picture 13](/images/b5df80dd82a9344214b16f5279575bbcd33263df51ff5728cf2c593b28ed8ec7.png)  

クッキー（Cookie）は各クライアントに保持されるため、APサーバーのメモリを圧迫することはありません。
しかし、クライアントの操作により削除される場合があります。

またクッキーに保存したデータは、リクエストのたびに毎回サーバーに送信します。
セッションとクッキーの特徴を理解したうえで、使い分けを考えていく必要があります。
