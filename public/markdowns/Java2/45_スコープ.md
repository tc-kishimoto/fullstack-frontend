# スコープ

---

スコープとは範囲という意味を表す言葉です。
変数が有効な範囲を変数のスコープと呼んだりします。
Webアプリケーションにおけるスコープは、APサーバーに値を保存しておく期間のことです。
Tomcatでは4つのスコープを扱うことができます。

- ページスコープ
- リクエストスコープ
- セッションスコープ
- アプリケーションスコープ

ページスコープが最も保持される期間が短く、アプリケーションスコープが最も期間がなくなります。
4つのスコープがありますが、実際によく使用されるのはリクエストスコープとセッションスコープで、ページスコープとアプリケーションスコープはほとんど使用されません。

以下のソースでそれぞれのソースの動作を確認してみましょう。

scope.jsp

```java
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>スコープの確認</title>
</head>
<body>
<%
// pageContext.removeAttribute("num");
// request.removeAttribute("num");
// session.removeAttribute("num");
// application.removeAttribute("num");

//////////////////////////////
// 1 ページスコープ
//////////////////////////////
// ページスコープから値を取得する
Integer ps = (Integer) pageContext.getAttribute("num");
// null対処
if (ps == null) {
    ps = 1;
}
ps++;
out.println("ページスコープ：" + ps + "<br>");
// ページスコープに値をセットする
pageContext.setAttribute("num", ps);

//////////////////////////////
// 2 リクエストスコープ
//////////////////////////////
// リクエストスコープから値を取得
Integer rs = (Integer) request.getAttribute("num");
// null対処
if (rs == null) {
    rs = 1;
}
rs++;
out.println("リクエストスコープ：" + rs + "<br>");
// リクエストスコープに値をセット
request.setAttribute("num", rs);

//////////////////////////////
// 3 セッションスコープ
//////////////////////////////
// セッションスコープから値をセット
Integer ss = (Integer) session.getAttribute("num");
// null対処
if (ss == null) {
    ss = 1;
}
ss++;
out.println("セッションスコープ：" + ss + "<br>");
// セッションスコープに値をセットする
session.setAttribute("num", ss);

//////////////////////////////
// 4 アプリケーションスコープ
//////////////////////////////
// アプリケーションから値を取得
Integer as = (Integer) application.getAttribute("num");
// null対処
if (as == null) {
    as = 1;
}
as++;
out.println("アプリケーションスコープ：" + as + "<br>");
// アプリケーションスコープに値をセット
application.setAttribute("num", as);
%>
<form action="scope.jsp">
  <button type="submit">カウントアップ</button>
</form>
</body>
</html>
```

結果

```text
ページスコープ：1
リクエストスコープ：1
セッションスコープ：1
アプリケーションスコープ：1
カウントアップ(ボタン)
```

最初は全てのスコープが1の状態になります。
カウントアップのボタンを押すと、それぞれのスコープに1を足す処理となっています。
動作を確認すると、ページスコープとリクエストスコープはずっと1のままになっているはずです。
一方で、セッションスコープとアプリケーションスコープはボタンを押すたびに1ずつ増えていきます。

### ページスコープとリクエストスコープ

上記のプログラムではページスコープとリクエストスコープの違いは分かりません。

ページスコープは、JSPページ内で有効となります。
ページスコープはあまり使われないと話しましたが、ページスコープでできることはローカル変数でできることと変わらないからです。
ページ内だけで使用する値を保存するだけなら、ローカル変数でも対応できるため、ページスコープはあまり使われていません。

リクエストスコープはリクエスト値が有効で、レスポンスされると値は消滅します。
JSPだけでプログラムを作成しているとリクエストスコープを使用するメリットは分かりにくいですが、サーブレットなどの技術と組み合わせてシステムを作成する際にはよく利用されます。
例えば、検索フォームにキーワードを入力して検索ボタンを押した場合などです。
このとき、検索キーワードがプログラムに送信され、データベースから該当するデータを取得してきます。
取得してきたデータはリクエストスコープにセットしておくことで、JSPでは検索結果を表示することが可能です。

### セッションスコープとアプリケーションスコープ

セッションスコープとアプリケーションスコープもこのプログラムでは違いが分かりにくいかもしれません。
異なるブラウザで動作確認すると違いが分かりやすくなります。
Google Chromeで確認しつつ、Edgeなど、別のブラウザを使用して同じプログラムを動かしてみてください。

セッションスコープの値はブラウザごとに1からカウントされます。
アプリケーションスコープは違うブラウザを使っても値が共有されているはずです。

アプリケーションスコープは、サーバーで1つだけ存在し、複数のクライアント間で共有されます。
アプリケーションスコープはサーバーを停止したり、再起動したりすると値はなくなります。
そのため、永続的にデータを保存しておきたい場合にはアプリケーションスコープを使うのは向いていません。
永続的にデータを保存する場合は、DB(データベース)を使用することがほとんどです。
そのためアプリケーションスコープが使用される場面は限られます。

セッションスコープはクライアント(Webブラウザ)単位で値を保持するスコープです。
つまりクライアントの数だけ存在します。

### 値の取得と設定方法

ここでスコープからの値の取得方法と値の設定方法について解説しておきます。

```java
// スコープへの値のセット
スコープのオブジェクト.setAttribute("key", 値);
// スコープからの値の取得
// 値を取得する際にはキャストする
型 変数 = (型) スコープのオブジェクト.getAttribute("key");
// 値の破棄
スコープのオブジェクト.removeAttribute("key");
```

値の取得とセット、それぞれで使用するメソッドはどのスコープでも同じです。
値のセットにはsetAttributeメソッドを使用します。
値の取得にはgetAttributeメソッドを使用します。
スコープのオブジェクトは、用途に応じてpageContext, request, session, applicationのいずれかを使用します。

setAttributeの第一引数とgetAttributeの引数には任意の文字列を指定できます。
どんな文字列でもかまいませんが、値のセットと取得側で同じ文字列である必要があります。
一般になんの値を扱っているのかが分かるような名前にします。

setAttributeメソッドの第二引数にはObject型を受け取ります。
つまり、任意の型の値を設定できます。
その代わり、値を取得する際にはキャストして使用したい型に戻してあげる必要があります。

値を意図的に破棄したい場合はremoveAttributeメソッドを使用することで破棄することができます。

### セッションスコープについて

セッションスコープについてはもう少し詳しく説明します。

セッションスコープはクライアント単位で値を保持しておくことができ、非常に便利です。
しかし、クライアントが増えるとその分だけスコープができるため、使い方によってはサーバーのメモリ容量を圧迫して、プログラムのパフォーマンスに影響を与えてしまう可能性もあります。
そのため、リクエストスコープでやり取りできる値に関してはできる限りリクエストスコープでやり取りするなどの工夫が必要です。

セッションはクライアントの数だけ作成されますが、ログアウトしたユーザーや一定時間操作がされていないセッションの情報をずっと保持していれば、メモリを無駄に使用することになります。
多くのAPサーバーでは一定の時間操作がなかった場合には自動的にセッションを削除するようになっており、Tomcatではデフォルトで30分でセッションを削除するようになっています。
この設定はWeb.xmlという設定ファイルで変更することが可能です。
また、セッションはremoveAttributeメソッドやinvalidateメソッドを使用して明示的にデータを削除することも可能です。
ログアウトした際など、不要なセッションは削除するように処理しておくことが大切です。

### セッションを識別する仕組み

セッションはクライアントの数だけ存在します。
つまり、10人が同時にそのプログラムを利用している場合は、10個のセッションが存在することになります。
この時、どのクライアントの情報がどのセッション情報なのかを識別する仕組みが必要になります。

この時に使用されるのがCookieと呼ばれる技術です。
Cookieはクライアント(Webブラウザ)に保存されるテキストデータです。
APサーバー(Tomcat)は、セッションを作成するとき、同時にセッションIDと呼ばれる値(英数字の列)を生成します。
そして、レスポンスを返す際にこのセッションIDをクライアントのCookieにセットします。
クライアントは同じWebサーバーにリクエストを送信する際に、Cookieに保存されたセッションIDも同時に送信します。

APサーバーはクライアントから送られてきたセッションIDを元に、紐づいているセッションを識別します。

Cookieの仕組みは便利ですがいくつか注意点もあります。
Cookieはブラウザに保存されているテキストデータなので、ブラウザの操作によって削除することも可能です。
Webサービスを利用している最中にCookieのデータを削除すると、セッションIDも削除されるため、ログインしていた状態が失われてしまう可能性があります。
また、セッションIDが不正に第三者に知られてしまった場合、不正ログインされてしまうなど、セキュリティ面にも注意が必要です。
