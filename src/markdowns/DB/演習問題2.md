# DB_演習問題2

---

## 演習問題-SQL2-基本

---

* 演習問題1(基本)で作成した学生と専攻を表すテーブルに対して、様々な検索を行っていきます。

* 演習問題1(基本)を最後まで実行した状態から、本演習を開始してください。

(studentテーブルのstudent_id = 10のレコードが削除されている状態)

* "db_exam2.sql"というテキストファイルを作成し、SQL文を全て記載して提出してください。

### 作成するSQL文

#### 1. AND条件、並べ替え

studentテーブルに対して、gradeが1かつ、hometownが"東京"のレコードを取得してください  
実行結果は、student_idの昇順に表示してください  

<実行結果イメージ>

|student_id|student_name|grade|hometown|major_id|
|----------|------------|-----|--------|--------|
|2|田中|1|東京|2|
|3|佐藤|1|東京|3|

#### 2. OR条件、LIKE指定、並べ替え  

studentテーブルに対して、gradeが1または、student_nameが'本'で終わっているレコードを取得してください。

実行結果はstudent_idの降順に表示してください。

<実行結果イメージ>  
|student_id|student_name|grade|hometown|major_id|
|----------|------------|-----|--------|--------|
|9|森本|4|沖縄|4|
|8|山本|3|神奈川|3|
|3|佐藤|1|東京|3|
|2|田中|1|東京|2|
|1|山田|1|宮城|1|

#### 3. GROUP_BY、MAX  

studentテーブルに対して、各major_id毎にgradeの最大値がいくつかを取得してください。(各専攻毎に最大の学年はいくつか調べる)  
実行結果はmajor_idの昇順に表示してください。

<実行結果イメージ>  
|major_id|max|
|--------|---|
|1|2|
|2|3|
|3|3|
|4|4|

#### 4. GROUP_BY、COUNT、HAVING  

studentテーブルに対して、2件以上存在するhometownの値と、レコード件数を取得してください。

(2人以上出身地が同じ学年がいる場合の、出身地の名称と件数を調べる)  
実行結果はhometownの昇順に表示して下さい。

<実行結果イメージ>  
|hometown|count|
|--------|-----|
|鹿児島|2|
|東京|3|

#### 5. JOIN、並べ替え  

studentテーブルとmajorテーブルを結合し、student_name、major_nameのみを表示してください。

実行結果は第1出力順をmajor_nameの昇順、第2出力順をsturdent_nameの昇順で表示してください。

<実行結果イメージ>

|student_name|major_name|
|------------|----------|
|吉田|英文学|
|山田|英文学|
|鈴木|英文学|
|伊藤|応用科学|
|高橋|応用科学|
|田中|応用科学|
|森本|経済学|
|佐藤|情報工学|
|山本|情報工学|

#### 6. JOIN、条件指定、並べ替え

studentテーブルとmajorテーブルを結合し、hometownが'東京'以外のレコードを取得してください。

実行結果には、student_id, student_name, hometown, major_nameのみを、第1出力順をmajor_nameの昇順、第2出力順をstudent_idの昇順で表示してください。

<実行結果イメージ>

|student_id|student_name|hometown|major_name|
|----------|------------|--------|----------|
|1|山田|宮城|英文学|
|4|鈴木|鹿児島|英文学|
|5|高橋|北海道|応用科学|
|7|伊藤|鹿児島|応用科学|
|9|森本|沖縄|経済学|
|8|山本|神奈川|情報工学|

#### 7. サブクエリ-その1  

専攻が'英文学'の学生を取得してください。

実行結果は、student_id, student_name, gradeのみをstudent_idの昇順に表示してください。

サブクエリを使用し、下記の検索を一つのSQL文で実行してください。


* majorテーブルに対して、major_nameが'英文学'のmajor_idを取得
* 上記で取得したidをWHERE句の条件に使用し、studentテーブルを検索

<実行結果イメージ>

|student_id|student_name|grade|
|----------|------------|-----|
|1|山田|1|
|4|鈴木|2|
|6|吉田|2|

#### 8. サブクエリ-その2 IN  

同じ専攻が3人以上いる学生を取得してください。

実行結果は、student_id, student_name, major_idのみを第1出力順をmajor_idの昇順、第2出力順をstudent_idの昇順で表示してください。

サブクエリを使用し、下記の検索を1つのSQLで実行してください。


* studentテーブルに対して、3件以上存在するmajor_idを取得  
* 上記で取得したidをWHERE句の条件に使用し、studentテーブルを検索

<実行結果イメージ>

|student_id|student_name|major_id|
|----------|------------|--------|
|1|山田|1|
|4|鈴木|1|
|6|吉田|1|
|2|田中|2|
|5|高橋|2|
|7|伊藤|2|

---

## 演習問題-SQL2-発展

---

* 演習問題1(発展)で作成した売上と顧客を表すテーブルにたいして、様々な処理を行っていきます。

* 演習問題1(発展)を最後まで実行した状態から、本演習を開始してください。

(salesテーブルのamountがNULLのレコードが削除されている状態)  
最後まで実行していない状態でも演習は行えますが、実行イメージは異なる可能性があります。

* "db_exam_dev2.sql"というテキストファイルを作成し、SQL文を全て記載して提出してください。


### 作成するSQL文

#### 1. CREATE  

"sales_old"という名前の下記のテーブルを作成してください。

("sales_old"テーブルから"sales"テーブルへのデータ移行を想定しています)  

|カラム名|型|制約|説明|
|-------|--|----|----|
|sales_id|INT|PRIMARY KEY|売上ID(管理番号)  主キー|
|order_date|DATE||注文日|
|customer_id|INT|NOT NULL,  REFERENCES customer(customer_id)|顧客ID(customerテーブルのcustomer_idと紐づく)|
|amount|DECIMAL||売上金額|

#### 2. INSERT  

sales_oldテーブルへ下記データを登録してください。

|sales_id|order_date|customer_id|amount|
|--------|----------|-----------|------|
|6|2018/09/02|2|20000|
|7|2018/09/02|1|5000|
|8|2018/09/02|3|6000|
|9|2018/09/05|1|3000|

#### 3. INSERT、SELECT  

sales_oldテーブルのデータをsalesテーブルへ追加してください。

※別テーブルへのデータ追加方法は補足説明を参考にしてください。


<データ追加後のsalesテーブル内のデータイメージ>

|sales_id|order_date|customer_id|amount|
|--------|----------|-----------|------|
|1|2018/11/01|1|3000|
|2|2018/10/01|3|5000|
|3|2018/10/01|4|6000|
|4|2018/11/05|4|2000|
|6|2018/09/02|2|20000|
|7|2018/09/02|1|5000|
|8|2018/09/02|3|6000|
|9|2018/09/05|1|3000|

#### 4. DROP

sales_oldテーブルを削除してください。

(sales_oldテーブル内のデータではなく、テーブルそのものを削除すること)  

#### 5. CASE WHEN、別名

salesテーブルに対して、order_dateが'2018/10/01'より前のデータが分かる印をつけたカラム(カラム名はis_old)を取得してください。

実行結果は、sales_id, order_id, is_oldのみをorder_dateの昇順に表示してください。

※CASE WHENは補足説明を参考にしてください

<実行結果イメージ>  

|sales_id|order_date|is_old|
|--------|----------|------|
|6|2018/09/02|〇|
|8|2018/09/02|〇|
|7|2018/09/02|〇|
|9|2018/09/05|〇|
|3|2018/10/01||
|2|2018/11/01||
|1|2018/11/01||
|4|2018/22/05||

order_dateが'2018/10/01'より前は'〇'、それ以外は""(空文字)の文字列を表示する。

#### 6. 文字列結合、別名

customerテーブルに対して、customer_idとcustomer_nameの値を結合した文字列のカラム(カラム名はcustomer_id_name)を取得してください。

実行結果は、customer_id_nameのみをcustomer_idの昇順に表示してください。

※文字列結合は補足説明を参考にしてください。

<実行結果イメージ>

|customer_id_name|
|:--|
|1:田中|
|2:鈴木|
|3:田中|
|4:田島|

customer_idの値と';'(コロン)とcustomer_nameの値を結合した文字列を表示する  

#### 7. LIMIT

salesテーブルに対して、customer_idが1のレコードを取得してください。

ただし、実行結果はorder_dateの降順に最大2件分表示してください。

※LIMITは補足説明を参考にしてください。

<実行結果イメージ>  

|sales_id|order_date|customer_id|amount|
|--------|----------|-----------|------|
|1|2018/11/01|1|3000|
|9|2018/09/05|1|3000|

#### 8. GROUP BY、MIN、SUM、サブクエリ、別名

salesテーブルに対して、order_dateの最小値と、order_dateがその値の時のamountの合計値(カラム名はsum_amount)を取得してください。

(売上が発生した最初の日付と、その日の売上の合計金額を取得)  
サブクエリを使用し、上記の検索を1つのSQL文で実行してください。


* salesテーブルに対して、order_dateの最小値を取得  
* 上記で取得したorder_dateをWHERE句の条件に使用し、salesテーブルを検索  

<実行結果イメージ>

|order_date|sum_amount|
|----------|----------|
|2018/09/02|31000|

#### 9. GROUP BY、JOIN、AVG、TRUNC、別名  

salesテーブルとcustomerテーブルを結合しcustomer_id、customer_nameごとのamountの平均値(カラム名はavg_amount)を取得してください。

(顧客ごとの平均売上金額を取得する)  
ただし、amountの平均値は、小数点以下は切り捨てにしてください。

実行結果は、customer_id, customer_name, avg_amountのみをcustomer_idの昇順に表示してください。

※TRUNCは補足説明を参考にしてください。

<実行結果イメージ>

|customer_id|customer_name|avg_amount|
|-----------|-------------|----------|
|1|田中|3666|
|2|鈴木|20000|
|3|田中|5500|
|4|田島|4000|

#### 10. BETWEEN、LIMIT、サブクエリ  

salesテーブルに対して、order_dateが'2018/09/01'から'2018/09/30'の範囲で、amountが一番大きいレコードを表示してください。

サブクエリを使用し、上記の検索を1つのSQL文で実行してください。

* salesテーブルに対して、'2018/09/01'から'2018/09/30'の範囲でamountの降順に最大1件分のsales_idを取得
* 上記で取得したsales_idをWHERE句の条件に使用し、salesテーブルを検索  

<実行結果イメージ>

|sales_id|order_date|customer_id|amount|
|--------|----------|-----------|------|
|6|2018/09/02|2|20000|

### 補足

* テーブルから他のテーブルへのデータ挿入方法  
下記構文を使用することで、SELECTの結果をテーブルに挿入できます。

``` sql
INSERT INTO テーブル名 
(第1カラム名、第2カラム名、...) 
SELECT 第1カラム名、第2カラム名、... 
FROM テーブル名

-- 使用例
INSERT INTO users 
SELECT * FROM users_old
```

上記の場合、users_oldテーブルのレコードの件数が3件だった場合、その3件がusersテーブルに挿入されます。

* CASE WHEN

下記構文を使用することで、条件に応じた値を出すことができます。

``` sql
CASE WHERE (条件) THEN (条件が正しい時の値) 
  [WHEN ...(略)]
  [ELSE (どの条件にも当てはまらなかった時の値)]  -- []の部分は省略可能です
END

-- 使用例
SELECT amount, 
  (CASE WHEN amount <= 3000 THEN '3000以下'  
        WHEN amount <= 50000 THEN '5000以下' 
        ELSE 'それ以外' END) AS msg 
FROM sales WHERE sales_id IN (1,2,3);
```

<実行結果>

|amount|msg|
|------|---|
|3000|3000以下|
|5000|5000以下|
|6000|それ以外|
amountの値に応じた結果を表示することができます。

* 文字列結合  
「||」演算子を使用することで文字列を結合することができます。

``` sql
SELECT '名前は' || customer_name AS name 
FROM customer 
```

<実行結果>

|name|
|:--:|
|名前は田中|
|名前は鈴木|
|名前は田中|
|名前は田島|
'名前は'という文字列にcustomer_nameの値を結合して表示することができます。

* TRUNC  
TRUNCという関数を使用することで値を切り捨てることができます。

このように数値に対して計算などを行う関数を算術関数といいます。

TRUNC以外にも、四捨五入や絶対値を求めるなど、様々な関数が用意されています。

|関数|例|結果|
|----|--|----|
|TRUNC(値)|SELECT TRUNC(15.25)|15|
|TRUNC(値、対象桁)|SELECT TRUNC(15.25, 1)|15.2|

* LIMIT

LIMITを使用することで、取得するレコードの件数の限度を指定することができます。

``` sql
SELECT * FROM customer 
ORDER BY customer_id LIMIT 2
```

この場合、customer_idの昇順に並べた際の最大(上から)2件を取得できます。
