# NoSQL

---

## 概要

* NoSQLについて学習します。
* NoSQLの1つであるMongoDBを学習します。

---

## NoSQLとは

DBの世界でNoSQLと呼ばれる分野のDBが注目を浴びるようになっています。
一昔前は、DBと言えばほとんどの場合でRDBを指すものでしたが、近年ではシステムの一部でRDB以外のDBを活用する場面も増えてきました。
NoSQLは、そんなRDB以外のDBMSを指す場合に使用される用語です。

ただし、実は明確な明確な定義はありません。
RDB以外に分類されるいくつかのDBをひとくくりにして呼ばれる用語です。

---

### NoSQLの種類

NoSQLは大きく分けて3つの種類がある。

* KVS(キーバリューストア）
  * キーとバリュー（値）がセットになっているデータを格納するNoSQLのDBです。
* ドキュメントDB
  * JSON形式のデータを格納するNoSQLのDBです。
* グラフDB
  * 関連性を表すデータを格納するNoSQLのDBです。

※RDB以外に分類されるDBはこのほかにも存在します。
例えば、XMLDBやオブジェクト指向DBなどです。
これらのDBはRDBではありませんが、一般にはNoSQLに分類されないそうです。

※NoSQLはRDBに比べると速いというイメージもあるようです。
厳密には、ドキュメントDBがその特性上ビッグデータの処理に向いており、NoSQLがRDBに比べて処理が速いというわけではありません。

---

## DBの4つのエリア

それぞれのDBを特性に応じて4つに分類すると、以下のようになります。

![picture 1](/images/92047f6ed1ee21db6e8b39ce2c8823ecb102fb82ccf227789b69afc5c5081a54.png)  

---

### KVS（キーバリューストア）

KVSは、キーとバリュー（値）がセットになっているデータを格納するNoSQLのDBです。

システムの設定ファイルのようなイメージです。

1つのキーに対して複数の値（カラム）をセットする、ワイドカラムと呼ばれるデータも扱うことができます。

---

### ドキュメントDB

JSON形式のデータを格納するNoSQLのDBです。
シンプルなデータしか扱わない場合はKVSでも十分でしたが、データ形式としてJSONが多く使われるようになった背景から、ドキュメントDBが誕生しました。

---

### JSON

JSONとは、JavaScript Object Notationの略で、軽量でテキストベースのデータ交換方式です。
変数名と値を「:」で区切り、「,」でデータを連結できます。

JSONの例
{ ID: 1234, NAME: "kishimoto" }

JSONでは、入れ子構造（階層構造）を表現できます。
また、配列なども扱うことができます。

JSONの例

```json
{
  id: 1234 ,
  name: "kishimoto" ,
  address: {
            city: "Okinawa",
            zipno: "901-0001"
  }
  tel: ["090-1234-5678", "080-1234-5678"]
}
```

RDBの場合、配列データ構造や入れ子構造のデータを扱うのは難易度が高いという問題がありました。
ドキュメントDBの場合、RDBでは扱いが難しかった配列や入れ子のデータ構造をJSONを使ってシンプルに扱うことができます。

---

### グラフDB

「グラフ」というのは、物事の関連性を表す表現方法です。
点（ノード）と、それらを結ぶ線（リレーション）で表現します。
RDBでは結合が多くなると処理速度が低下しますが、グラフDBではデータのつながりからデータをたどっていく複雑なクエリが高速で実行できます。

グラフの例

* SNSの人物間の関連
* 拠点間を結ぶ関連

リレーションと聞くとRDBをイメージする人もいることでしょう。
RDBとグラフDBの違いは、RDBはテーブル同士のリレーションを表現しているのに対し、グラフDBはデータ同士のリレーションを表現します。

---

## 各DBの特徴

### KVS

キーとバリューがセットになっているDB
KVSの中でも、「キーバリュー」と「ワイドカラム」の2種類があります。

KVSの製品

* Redis
* Cassandra
* Oracle NoSQL Database
* Amazon DynamoDB

---

### Redis

KVSに属するDB製品の1つです。

格納できる値には、「String」「List」「Set」「Hash」「Sorted Set」などがあります。

データの蓄積は基本的にメモリ上で行われるため、非常に高速です。
⇒ディスクへの書き出しやRDBによる永続化は可能。

条件検索や、order by、distinctなどの機能はありません。

### Redisの使いどころ

特徴から分かるように、RedisはRDBの代わりにはなりません。

大量かつ高速な処理が必要となる場合にシステムの一部に部分的に使用されるケースが多いです。

例えば、Webアプリケーションのキャッシュとして利用したりします。

---

### ドキュメントDB

KVSのバリューの値にJSONがセットされるDB。

ドキュメントDBの製品

* MongoDB
* Counchbase
* Microsoft Azure DocumentDB

---

## KVS/ドキュメントDBの特徴

### スケールアップが可能

KVSやドキュメントDBはスケールアウトできることが特徴になります。

スケールアウトとは、サーバーの台数を増やして処理性能を上げることをいいます。

スケールアップとは、CPUやメモリのスペックを上げて処理性能を上げること。

RDBでは外部キー制約やトランザクションの制約があるため、スケールアウトしても性能が上がりにくい傾向にあります。
サーバーの台数を増やした場合、テーブルがサーバー間で離れてしまう場合があります。
その場合、テーブル結合や外部キー制約のチェックが必要な処理では、複数台のサーバーをまたがって処理を行う必要が出てしまうため、全体として性能がアップしない可能性があります。

スケールアップによる性能向上は可能ですが、1台のサーバーでの性能アップには物理的に限界があります。

一方で、KVS/ドキュメントDBでは、スケールアップを可能にすることで、大量のデータでも高速に処理することが可能になります。

---

### スキーマレス

KVSやドキュメントDBは事前にデータ構造を定義する必要がないことが特徴の一つになります。

RDBだとレコードを挿入するためには事前にテーブル定義が必要になります。

しかし、ドキュメントDBは事前の定義が必要ありません。（定義することも可能）その分データ構造の変化に柔軟に対応することが可能になります。

### トレードオフ

それぞれの特徴を見ると、RDBより優れていると思うかもしれませんが、必ずしもそういうわけではありません。

スケールアップが可能ということは、言い換えればトランザクションや外部キー制約によって整合性を保つ機能を犠牲にしていることを意味します。

また、スキーマレスということは、どんなデータでも格納できる反面、データの管理が難しくなることを意味します。

RDBとNoSQLでどちらが優れているかということではなく、目的や用途に応じて使い分けることが大事です。

---

### スケールアウトができる仕組み

ドキュメントDBがスケールアウトを実現する技術は、主にシャーディング（水平処理）とレプリケーションの合わせ技になります。

ドキュメントDBではデータ同士の関連やトランザクションがないため、クエリを独立させて処理を分散させることができます。

また、レプリケーションを使って、読み込みと書き込みの処理を独立させることができるようになります。
これは、処理のタイミングによってはデータの内容が必ずしも整合性の取れたデータとならないことを意味します。

完璧な整合性を求めずに、大量のテキストデータを高速に処理したい場合にはドキュメントDBが有効な手段となります。

---

## グラフDB

関連性を表すデータを格納するDBです。

例えば、SNSの人間関係などを表すことができます。

グラフDBはRDB以上にデータ同士の関連性が強いため、そのためスケーラビリティ（サーバーを増やして性能を拡張できるか）はRDBよりも低い。

グラフDBの主な製品

* neo4j

---

neo4jの例

![picture 2](/images/ea8f9868e9b07f5797d44fefa61be1b2e31ac1c248395c98751881694110b760.png)  

---

## まとめ

* NoSQLとは、RDB以外に分類されるいくつかのDBの総称
* NoSQLには大きく3つの分類があり、KVS、ドキュメントDB、グラフDBがある
* KVSはkeyとvalueの組み合わせてデータを管理するDB
* ドキュメントDBはJSON形式でデータを管理するDB
* グラフDBはグラフ形式でデータ同士のリレーションを管理するDB
* KVSとドキュメントDBは、スケールアップが可能、スキーマレスなどの特徴がある
* NoSQLはRDBの代わりになるモノではなく、RDBでは苦手な分野を補うための特徴を持ったDB群
* 目的やシーンに合わせてRDBと組み合わせながら使用する
