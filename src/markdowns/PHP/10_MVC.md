# MVCモデル

---

## 概要

Webアプリケーションの設計思想であるMVCモデルについて学びます。


---

MVCモデルは、Webアプリケーションの設計で多く取り入れられているモデルの一つです。
プログラムの規模が大きくなるとソースコードの量は増えます。
ソースコードの量が増える場合、役割ごとに適切にファイルやクラスを分けることが重要になってきます。
MVCモデルでは、WebアプリケーションをM(Model)、V(View)、C(Controller)の３つの役割に分けて作成する設計思想です。

---

MVCモデルのMVCはそれぞれ以下の略になります。

* M：Model
* V：View
* C：Controller

### Model

Modelは、Webアプリケーションの処理を担う部分です。
DBアクセスや、計算処理などがModelにあたります。

### View

ViewはWebアプリケーションの見た目の部分を担当します。
一言で言えばHTMLが書かれている（HTMLに変換される）部分です。

### Controller

ControllerはModelとViewの橋渡しを担う部分です。
Viewから送られてきたリクエストパラメータを受け取り、Modelに渡す役割を持ちます。
また、Modelでの処理結果をViewに渡して結果を表示するための橋渡しを担います。

---

### MVCモデルのイメージ

![picture 27](/images/27f5beae2e564d25f4a6dbf56196f6cd599be3717b263ce11965846b15ea912a.png)  

---

## ログインシステムを作る

MVCを理解するためのサンプルプログラムとして、ログインしてマイページに遷移するプログラムを作成してみます。
全体のイメージは以下の図の通りです。
Modelの部分はサービスというファイル（クラス）が担当することにします。
次ページ以降、各プログラムの概要を説明します。

![picture 28](/images/94f368a36ad6f739733a92e2c237026effe44bc208b30fa687664a1909c92f20.png)  

---

* ログインページ
  * IDとパスワードの入力欄があり、コントローラに入力情報を送る。
* ログインコントローラ
  * ログインページからの入力値を受け取り、ログインサービスに受け渡す。
  * ログインサービスからの処理結果を受け取り、結果によってマイページかログインページへ遷移する。
* ログインサービス
  * 受け取ったIDとパスワードを判定し、結果を返す。
  * 今回は、固定の文字列でIDとパスワードを判定することとする。
* マイページ
  * ログインに成功した場合に表示される。
  * ログイン者の情報を表示する。

---

### ログインサービス

先にログインサービスを作成しておきます。
ここではクラスにして、idとパスワードをチェックするメソッドを追加します。

LoginService.php

```php
<?php
class LoginService 
{
    public function loginCheck($id, $pass)
    {
        if($id === 'admin' && $pass === 'password') {
            return true;
        } else {
            return false;
        }
    }
}
```

---

### ログインページ

次にログインページを作成します。
IDとパスワードの入力欄を用意し、ログインコントローラにリクエストが飛ぶようにします。

login.php

```php
<form action="login-controller.php" method="POST">
    <p>
        ログインID：<input type="text" name="id">
    </p>
    <p>
        パスワード：<input type="password" name="pass">
    </p>
    <button type="submit">ログイン</button>
</form>
```

---

### ログインコントローラ

ログインコントローラでは、ログインサービスを呼び出して結果によって表示するページを分けます。
成功した場合はセッションにIDを保管しておきます。

login-controller.php

```php
<?php
require_once('LoginService.php');
$loginService = new LoginService();

if($loginService->loginCheck($_POST['id'], $_POST['pass'])) {
    $_SESSION['user_id'] = $_POST['id'];
    include('mypage.php');
} else {
    include('login.php');
}
```

---

### マイページ

マイページではセッションに保持されたIDを表示します。

mypage.php

```php
<p>
ようこそ <?= $_SESSION['user_id'] ?> さん
</p>
```

---

処理の流れ

![picture 29](/images/c04a966d43e942f467185d1626c6a5d4ebb27b455759b64ed93bb152b696309a.png)  

---

作成し終えたら、ログインページから

```text
ログインID：admin
パスワード：password
```

で入力し、マイページに遷移できることを確認してください。

どのような流れで処理が実行されているのかを把握できるようにしておいてください。

※今回のプログラムはMVCのイメージを持ってもらうためのプログラムで、セキュリティやエラーが出た場合の考慮はしていません。
実際にログインシステムはもっと複雑になります。

---

# 画面遷移

---

## PHPによる画面遷移

Webページが別のWebページに切り替わることを、一般に画面遷移と呼びます。
画面遷移を実現する方法には、aタグによるリンクのクリックや、formタグ内のsubmitボタンのクリックなどがあります。
ですが、Webアプリでは、処理結果によって遷移する画面が異なる場合も多くあります。（ログインが成功したか失敗したかによって遷移先の画面が異なる、など）
この場合、PHPなどのプログラムによって画面遷移をコントロールする必要が出てきます。

---

PHPでは画面遷移を実現する方法として主に２つの手段があります。

1. includeによって遷移先の画面を読み込む方法

```php
include('読み込むphpファイルのパス');
```

2. header関数によってリダイレクトする方法

```php
header('Location: 遷移先のPHPファイルのパス');
```

どちらでも画面遷移は可能ですが、それぞれで動作が異なるため、状況に応じて使い分ける必要があります。

---

## includeの場合

* URL
  * includeの場合、表示させたい画面を読み込む形になるため、URLはinclude元のプログラムのファイル名が表示される形になります。
* 変数
  * includeの場合、includeしているプログラム内で宣言した変数などは、include先のファイルでも使用することができます。

---

## header関数の場合

* URL
  * header関数を使って画面遷移した場合は、URLはheader関数内で指定したPHPファイルになります。
* 変数
  * header関数を使った場合、header関数の呼び出し元のファイルで宣言した変数は、遷移先のプログラムで使用することはできません。
  * 値を共有したい場合には、セッションなどを使う必要があります。

---

## まとめ

MVCモデルではM,V,Cの3つに役割分担されていますが、DBに関する処理が入ると、Modelの部分はさらに細かく役割分担される場合がほとんどです。

役割分担が細かくなるとファイルの数が増えるため、慣れないうちは複雑に感じるかもしれません。

しかし、プログラムの規模が大きくなればなるほど、うまく役割分担されていた方がメンテナンスがしやすくなります。

また、Webアプリケーション用のフレームワークを使用する場合、MVCモデルの考え方が採用されている場合が多いので、慣れておくようにしましょう。

---

* MVCモデルはWebアプリケーション開発における設計思想
* MはModelの略で、処理を担当する
* VはViewの略で、見た目を担当する
* Controllerは、ViewとModelの橋渡しを担当する
* Webアプリケーション用のフレームワークでは、MVCモデルの考え方が広く取り入れられている
* PHPで画面遷移するには2種類の方法がある
* includeでファイルを読み込む方法と、header関数でリダイレクトする方法がある
* それぞれの方法で、URLと、変数が使えるかどうかが異なる
