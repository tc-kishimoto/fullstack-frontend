# フォームとの連携

---

## 概要

* フォームの基本と、フォームから入力された値をPHPで取得す方法について学習します。
* GETとPOSTの違いについて学習します。
* クロスサイトスクリプティングと、その対策について学習します。

Webアプリケーションを開発するうえでは、ユーザーからの入力を受け付けて、それによって処理結果を表示することが必要です。

例えば、キーワードからの検索や、ログイン処理などです。

![picture 4](/images/fea5e3711be05e97762c1b6ddce15aa07897220be3c9ef2b310846d925d2bf5f.png)  

---

## フォーム

HTMLで入力項目を作成するにはformタグを使用します。
ここでは、PHPの話に入る前に、HTMLについての復習から入ります。
fromタグの使用方法について振り返ってみます。
ここでは簡単な例として、入力項目を２つ設けて「送信」ボタンを押すと、入力した数値を足した結果を表示するプログラムを考えます。

![picture 5](/images/f4ad9483c609e0a5c282908d224f51da00eef3f06830dfb6c15883d9942316ac.png)  

---

bodyタグの中には以下のような内容を記述します。

formタグには、action属性とmethod属性を指定します。

action属性には、遷移先のプログラムを記述します。

今回はanswer.phpというプログラムを作成することにします。

form1.php

```html
<form action="answer.php" method="GET">
    <input type="text" name="num1" size="10">
    +
    <input type="text" name="num2" size="10">
    <br>
    <button type="submit" name="button">送信</button>
</form>
```

---

formタグのmethod属性には、"GET"または"POST"を指定します。GETとPOSTの違いについては後々解説します。

method属性を省略した場合は、自動的にGETが指定されたことになるので、それも合わせて覚えておきましょう。


```html
<form action="answer.php" method="GET">
```

テキストボックスはinputタグで、type属性に"text"を指定します。
name属性は、遷移先で入力値を取得する際に必要になるので、必ず指定するようにしましょう。また、他のタグのname属性と重複しないように、分かりやすい名前を付けましょう。
name属性の値を「リクエストパラメータ」といいます。

```html
<input type="text" name="num1" size="10">
```

ボタンを表示するにはbuttonタグを使用します。

type属性は指定できる値がいくつかありますが、画面を遷移させるには"submit"を指定します。


```html
<button type="submit" name="button">送信</button>
```

ブラウザから見た入力フォームは以下のようになります。

![picture 6](/images/12691abdaebc89722ecac0350d9686e8a189c1e6495888e3c294c3e80982a349.png)  

---

次は値を受け取って計算するプログラムを見ていきます。



answer.phpの中身は以下のようになります。

```php
<?php
$num1 = $_GET["num1"];
$num2 = $_GET["num2"];
echo $num1 + $num2;
```

「$_GET」はPHPであらかじめ用意されている変数です。配列になっており、フォームから送られてきた情報が格納されます。

name属性の値が配列のキーになり、value属性の値が要素として格納されます。（テキストボックスの場合は入力値がそのままvalue属性の値になります。）

name属性の値を配列の引数として受けっているのが分かります。

formタグのmethod属性が"GET"の場合は`$_GET`を使用します。method属性が"POST"の場合は`$_POST`を使用します。

---

## GETとPOST

先ほどはformタグのmethod属性が"GET"でした。

次はPOSTの場合を見ていきましょう。

まずは入力フォームのmethod属性を"POST"に変更します。

```html
<form action="answer.php"  method="POST">
    <input type="text" name="num1" size="10">
    +
    <input type="text" name="num2" size="10">
    <br>
    <button type="submit" name="button">送信</button>
</form>
```

次にanswer.phpの方で「`$_GET`」を「`$_POST`」に変更します。

```php
<?php
$num1 = $_POST["num1"];
$num2 = $_POST["num2"];
echo $num1 + $num2;
```

---

動作を確認してみます。
GETの場合と同じような結果になります。ここだけ見ても違いはないように見えます。GETとPOSTでは何が変わるでしょうか。

実は、GETとPOSTの違いは表示されるURLに現れます。

GETの場合

```text
localhost/answer.php?num1=1%num2=2
```

POSTの場合

```text
localhost/answer.php
```

GETの場合、URLに「?パラメータ名=値」が連結されて表示されます。パラメータが複数ある場合は「&」でくっつけて連結します。
POSTの場合は送信された情報がURLに連結されません。
GETではURLにリクエストパラーメータがつきます。
POSTはURLにリクエストパラーメータがつきません。
この2つをどう使い分ければ良いでしょうか。

---

GETとPOSTを使い分け方を見ていきましょう。
ユーザー名とパスワードを入力してログインを行う場面を考えましょう。

入力したユーザー名とパスワードが特定の値と一致した場合は、画面遷移して、「ようこそ「〇〇」さん」と表示します。

![picture 7](/images/35039ffdd04aa3ee7c2a104fa88231fb8a163d82f9aea2ef80605f3f97a3b2a4.png)  

![picture 8](/images/17bf0b7876055b219d1e206d452590c6b696fad413c0eb32a369fb13f685e24c.png)  

結果

```text
ようこそ「あいうえお」さん
```

---

このとき、GETを使用していたとします。

その場合、リクエストパラメータがURLに表示されてしまい、本来表示されてはいけないパスワードの値が表示されてしまっています。これはセキュリティの観点から問題があります。

```text
localhost/answer2.php?name=あいうえお&pass=abcde
```

このように、漏れてはいけない情報を送信する場合にはGETを使用してはいけません。必ずPOSTを使用します。
では次はGETを使うタイミングを見てみましょう。
ショッピングサイトで商品を検索した場合、URLに商品の情報が付随されているのが分かります。

![picture 9](/images/ca97d96fdf71dee82e509552e1551e7e4941c05daa74539e56ff9e704011c91a.png)  

URLに情報が付随されていると、そのURLをそのままお気に入りとして保存することができます。
そうすれば、次回同じような検索をしなくても、気に入った商品のページをすぐに表示することができます。

---

以上をまとめると

**個人情報などを含む、漏れてはいけない情報を送信する場合はPOSTを使用する**

**お気に入りに登録する可能性があるページ（検索結果を表示する場合）などはGETを使用する**

となります。
GETは、パラメータがURLに付随されますが、文字列の長さには限りがあるため、送信する情報量が多い場合にもPOSTを使用します。
また、POSTでリクエストを送信した場合でも、ネットワーク盗聴によって情報が盗まれる可能性はあります。
リクエストをPOSTにしたからといってデータが全て安全になるわけではないことに注意してください。

---

### スーパーグローバル変数

先に紹介したプログラムではリクエストパラメータの値を取得するために$_GETと$_POSTという２つの変数を使用しましたが、これらの変数は一体なんなのでしょうか。

実はPHPには、あらかじめ定義されていてどこでも自由に扱うことができる変数がいくつか用意されています。

これらの変数はスーパーグローバルと呼ばれ、ほとんどが「$_」から始まる変数となっています。

`$_GET`、`$_POST`の他にも、`$_REQUEST`、`$_SESSION`などがあります。

詳しくはマニュアルを参照ください。

https://www.php.net/manual/ja/language.variables.superglobals.php

---

## XSSとエスケープ処理

以下のような、テキストボックスで名前を入力し、受け取った値を表示するプログラムを考えます。

![picture 10](/images/3bf1cbc8ee66710ef36bb4108508be328344c2a5273ece9c314633631789655c.png)  

---

ソースコードは以下のようになります。

name-input.php

```html
<form action="nameOutput.php" method="POST">
<p>名前を入力してください</p>
<p><input type="text" name="name"></p>
<p><button type="submit">送信</button></p>
</form>
```

name-output.php

```php
<?php
$name = $_POST['name'];
echo 'こんにちは ' , $name , ' さん。';
```

---

ここでHTMLタグ使った文字を入力してみます。
strongタグはコンテンツを強調表示するタグですが、タグが適用された内容で表示されているのがわかります。

![picture 11](/images/676846e588fe31ca2102be2e21b1f1286719bfcee4cb5d2a7301eedbc2a752d5.png)  

このように受け取ったデータのタグをそのままHTMLタグとして表示するプログラムはセキュリティ的に問題があります。
強調表示程度であれば大きな問題にはなりませんが、scriptタグなどを使って、JavaScriptの悪意あるプログラムを埋め込まれたりすると様々な問題が発生してしまう可能性があります。
このように、入力フォームを利用して悪意あるプログラムを埋め込むような攻撃のことを
**クロスサイトスクリプティング(XSS)**と呼びます。

---

入力された値を画面に表示する処理を行う場合、XSS対策を行う必要があります。
XSSが起きないように、入力フォームで受け取った値を画面に出力する場合は、HTMLタグを別の文字へ変換する必要があります。

出力したい値をhtmlspecialcharsという命令（関数）で囲ってみます。

name-output.php

```php
<?php
$name = $_POST['name'];
echo 'こんにちは ' , htmlspecialchars($name) , ' さん。';
```

---

タグがそのままの状態で出力されるようになります。
htmlspecialchars関数は、HTMLで使用される特殊記号（<, >など）を別の文字に変換してくれます。
このような処理のことをエスケープ処理といいます。

![picture 12](/images/f860b47653748875647cec7b7123a66692d00ae3142dd38c02e00eac4a7b82ef.png)  

XSSの脆弱性は、個人情報の漏洩など、重大なセキュリティ事故につながる可能性もあります。
入力フォームから受け取った値を画面への出力として使用する場合は、必ずエスケープ処理を実施するようにしてください。

---

## ?? 演算子

GETやPOSTで送られてきた値を受け取るには、以下のように`$_GET`や`$_POST`変数で受け取ることができます。

しかし、GETやPOSTでリクエストが送られてこなかった場合に`$_GET`や`$_POST`を使用して値を受け取ろうとするとエラーになってしまいます。（URLで直接answer.phpを指定したらエラーが発生する。）

answer.php

```php
<?php
$num1 = $_POST["num1"];
$num2 = $_POST["num2"];
echo $num1 + $num2;
```

---

リクエストで値が送られてきていない場合には、エラーを出さずに初期値を設定したい場合には、??演算子を使用することができます。

以下の例では、POSTでnum1やnum2というリクエストが送られてこなかった場合には、$num1や$num2に0がセットされるようになります。

エラーにならないように有効に活用しましょう。

```php
<?php
$num1 = $_POST["num1"] ?? 0;
$num2 = $_POST["num2"] ?? 0;
echo $num1 + $num2;
```

---

## まとめ

* ユーザーからの入力値を受け取るには、formタグを使用する。
* 値の送り方にはGETとPOSTの2種類がある。
* 検索など、URLで情報共有をする場合にはGETを使用する。
* 登録など、個人情報を含むようなデータを送信する場合にはPOSTを使用する。
* 入力フォームに悪意のあるプログラムを埋め込む攻撃にことをクロスサイトスクリプティング（XSS）という。
* XSS対策として、入力された値を出力する場合にはエスケープ処理を施す。

---

## 講義動画

[フォームとの連携](https://youtu.be/ijJ4t3AjJ5w)
