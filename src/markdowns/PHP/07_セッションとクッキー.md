# セッションとクッキー

---

## 概要

画面を跨いでも値を保持できる仕組みを学習します。
セッションの仕組みについて学習します。
クッキーの仕組みについて学習します。

---

## セッション

ログインして使用するWebシステムでは、ログインしたユーザーの情報を一定期間保持しておく必要があります。

サーバー上に一定期間情報を保持するための仕組みがセッションです。


以下のプログラムを確認してください。

```php
<body>
<?php
session_start();
if(!isset($_SESSION['num'])) {
    $_SESSION['num'] = 0;
} else {
    $_SESSION['num'] += 1;
}
?>
<p><?= $_SESSION['num'] ?></p>
<form action="session.php">
    <button type="submit">クリック</button>
</form>
</body>

```

---

結果は以下のようになります。


![picture 1](/images/6e79d7c8561462e29c402fd21428a310d169020f4190991f3644258a8da40edd.png)  

はじめは0が表示されていますが、クリックする、またはページを再読み込みする度に数値が１ずつ増えていきます。


---

プログラムを確認していきます。

PHPでセッションを利用するには、プログラムの最初にsession_start関数を実行する必要があります。


```text
session_start();
```

isset関数は、引数に指定された変数に値がセットされているかどうかをbooleanで返す関数です。

値がセットされている場合はtrue、セットされていないかnullの場合はfalseが返ってきます。


```text
!isset($_SESSION['num'])
```

セッションで保持する値は`$_SESSION`というスーパーグローバル変数で保持することができます。

連想配列になっており、任意のキーで値を保持できます。

ここではnumというキーで初期値0をセットし、ページが読み込まれるごとに値を加算します。


```php
if(!isset($_SESSION['num'])) {
    $_SESSION['num'] = 0;
} else {
    $_SESSION['num'] += 1;
}
```

今回のサンプルでは同じページに遷移するようにしましたが、セッションを使うことで複数のページを跨いでも値を保持しておくことが可能になります。


---

## セッションの破棄

セッションはクライアント（Webブラウザ）毎に値が保持されています。

セッションの値はサーバー上のメモリ領域に保持されているため、接続されているクライアントの数が増えるとメモリを圧迫します。

無駄にメモリを圧迫しないように不要なセッションは適切に破棄することが望ましいです。


---

セッションを破棄してカウントアップをリセットできるようにします。

先ほどのプログラムにもう一つボタンを追加します。


```php
<body>
<?php
session_start();
if(!isset($_SESSION['num'])) {
    $_SESSION['num'] = 0;
} else {
    $_SESSION['num'] += 1;
}
?>
<p><?= $_SESSION['num'] ?></p>
<form action="session.php">
    <button type="submit">クリック</button>
</form>
<form action="sessionDiscord.php">
    <button type="submit">破棄</button>
</form>
</body>
```

---

セッションを破棄するようのプログラムを追加します。

セッションを破棄するには、unset関数を使って、連想配列の値を破棄します。


sessionDiscord.php

```php
<?php
session_start();
unset($_SESSION['num']);
echo 'セッションを破棄しました。';
?>
<form action="session.php">
    <button type="submit">戻る</button>
</form>
```

---

破棄をクリックすると、セッションの値がリセットされていることがわかります。

![picture 2](/images/25a8ee7893934ee7d2d3270c2039c01589de0c9c5b7f87e92779b2481350ac47.png)  

↓

![picture 3](/images/2dd653b6ef0f19903c2a207792af89d7b8cbecfb2b9656c6a36a43252e4bacb6.png)  

---

セッションの値は一定の時間を経過すれば自動的に破棄されますが、ログアウトが行われ場合など、明示的にセッションが不要になるタイミングでは極力セッションの値は破棄する方が良いでしょう。

unset関数は、引数で指定した変数の値を破棄する関数です。

$_SESSIONを丸ごとunsetの引数に入れてしまうとセッションそのものが使用できなくなってしまうので、必ず連想配列のキーを指定してセットするようにしましょう。


---

## セッションの設定

セッションがどのタイミングで削除されるかは、PHPの設定ファイル（php.ini）で設定することができます。


session.gc_maxlifetime  
セッションが削除対象になるでの時間を秒で指定します。


session.gc_probability, session.gc_divisor  
2つの値の組み合わせで、セッションが破棄される確率を指定します。


その他、php.iniで設定できるセッションの設定は下記の公式マニュアルで確認できます。

同じプログラムでも環境によってセッションの挙動が異なる場合などは、設定が異なっている可能性もあるので、そのような場合は設定ファイルを確認してみてください。


https://www.php.net/manual/ja/session.configuration.php  

---

## クッキー

クッキーは、クライアント（ブラウザ）毎に保持することができるテキストデータです。

セッションとも大きく関わっています。


セッションの値はサーバーのメモリ上でクライアント毎に保持されています。

Webアプリケーションでは不特定多数の人がアクセスするため、サーバー上では複数のセッション情報が保持されていることになります。

ではサーバーではどのようにセッションとクライアントを紐づけているのでしょうか。


実はサーバーでセッションが作成させると、セッションIDと呼ばれる、セッションごとに異なる英数字が割り振られています。

そして、サーバーがクライアントにレスポンスを返すときに、セッションIDをクッキーにセットしています。

クライアント（ブラウザ）は、リクエストの度にセッションIDを送信することで、セッションを特定することができます。


クッキーではセッションID以外の値を保持することも可能です。

PHPの場合、スーパーグローバル変数である`$_COOKIE`を使うことで、クッキーに値をセットすることができます。


---

ブラウザが保持しているクッキーの値はディベロッパーツールで確認することができます。

Chromeのディベロッパーツールを起動（F12）し、「Applicationタブ」の「Strage」→「Cookies」から確認できます。


![picture 4](/images/8f78c21d34cc7459acbb3f7512e7d3f37e4100730646baa60556604afe2c447d.png)  

---

## まとめ

* Webアプリケーションで画面を跨いでも値を保持したい場合はセッションを利用する
* セッションはサーバー上でクライアント毎に保持される値
* セッションはセッションIDによってクライアントを識別する
* クッキーはブラウザが保持できるテキスト情報
* クッキーにセッションIDを保持することでクライアントとセッションを紐づけている
